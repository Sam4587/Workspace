# 内容生成模块

## 概述

内容生成模块是 AI 内容创作系统的核心功能模块，负责基于热点话题和用户配置，利用 AI 技术自动生成高质量的内容。该模块集成多个 AI 模型，支持多种内容类型，并提供质量评估和优化建议。

## 模块架构

```
内容生成模块
├── AI 服务层
│   ├── OpenAI 服务
│   ├── 百度 AI 服务
│   ├── 讯飞 AI 服务
│   └── 模型切换策略
├── 生成控制层
│   ├── 提示词工程
│   ├── 参数配置
│   └── 模型选择
├── 质量评估层
│   ├── 内容完整性评估
│   ├── 语言流畅度评估
│   ├── 观点清晰度评估
│   ├── 吸引力评估
│   └── 规范性评估
├── 数据存储层
│   ├── 内容存储
│   ├── 草稿管理
│   └── 版本管理
└── 服务接口层
    ├── 生成内容 API
    ├── 获取内容 API
    ├── 更新内容 API
    └── 删除内容 API
```

## 核心文件

### 1. Content Model

**文件**: `server/models/Content.js`

**职责**: 定义内容的数据模型和索引。

**主要功能**:
- Schema 定义
- 内容类型验证
- 状态管理
- 索引创建

### 2. Multi AI Service

**文件**: `server/services/multiAIService.js`

**职责**: 统一封装多个 AI 模型的调用。

**主要功能**:
- OpenAI 接口调用
- 百度 AI 接口调用
- 讯飞 AI 接口调用
- 模型切换策略
- 错误处理和重试

### 3. AI Service

**文件**: `server/services/aiService.js`

**职责**: AI 内容生成的业务逻辑封装。

**主要功能**:
- 提示词构建
- 生成参数配置
- 结果解析
- 使用量统计

### 4. Quality Assessment

**文件**: `server/services/qualityAssessment.js`

**职责**: 内容质量评估和优化建议生成。

**主要功能**:
- 多维度质量评分
- 优化建议生成
- 辅助指标计算
- 评估结果输出

### 5. Content Router

**文件**: `server/routes/content.js`

**职责**: 提供 REST API 接口。

**主要功能**:
- 生成内容
- 获取内容列表
- 获取内容详情
- 更新内容
- 删除内容

### 6. Content Generation Page

**文件**: `src/pages/ContentGeneration.jsx`

**职责**: 前端内容生成页面。

**主要功能**:
- 内容类型选择
- 生成参数配置
- 内容预览
- 编辑功能
- 重新生成

## 数据流程

### 生成流程

```
用户选择热点话题
    ↓
填写生成参数
    ├── 内容类型选择
    ├── 标题输入
    ├── 关键词添加
    ├── 目标受众选择
    ├── 内容风格选择
    └── 其他选项配置
    ↓
构建提示词
    ├── 系统提示词
    └── 用户提示词
    ↓
调用 AI 模型
    ├── 优先 OpenAI
    ├── 失败则百度 AI
    └── 再失败则讯飞 AI
    ↓
解析生成结果
    ├── 提取内容文本
    ├── 记录使用量
    └── 保存模型信息
    ↓
质量评估
    ├── 计算质量分数
    ├── 生成优化建议
    └── 统计字数和阅读时间
    ↓
保存到数据库
    ├── 内容本体
    ├── 元数据
    ├── 评估结果
    └── 关联热点话题
    ↓
返回给前端
    ├── 内容预览
    ├── 质量分数
    └── 优化建议
```

## API 接口

### 1. 生成内容

```
POST /api/content/generate
```

**请求体**:
```json
{
  "type": "article",
  "title": "人工智能在医疗领域的应用",
  "topic": "人工智能在医疗领域的应用",
  "keywords": "人工智能,医疗,AI",
  "targetAudience": "医疗从业者",
  "tone": "professional",
  "length": "medium",
  "includeData": true,
  "includeCase": false,
  "includeExpert": false,
  "hotTopicId": "60d5ec9f8b8c6d1e8c8d7e8a"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "_id": "60d5ec9f8b8c6d1e8c8d7e8b",
    "title": "人工智能在医疗领域的应用",
    "content": "随着人工智能技术的快速发展...",
    "type": "article",
    "hotTopicId": "60d5ec9f8b8c6d1e8c8d7e8a",
    "keywords": ["人工智能", "医疗", "AI"],
    "wordCount": 1200,
    "readingTime": 5,
    "quality": 85,
    "suggestions": ["可以增加具体案例"],
    "status": "draft",
    "author": "AI生成",
    "metadata": {
      "targetAudience": "医疗从业者",
      "tone": "professional",
      "length": "medium",
      "includeData": true,
      "includeCase": false,
      "includeExpert": false
    },
    "createdAt": "2024-02-14T11:00:00Z",
    "updatedAt": "2024-02-14T11:00:00Z"
  }
}
```

### 2. 获取内容列表

```
GET /api/content
```

**查询参数**:
```javascript
{
  page: 1,
  limit: 20,
  type: 'article',
  status: 'draft',
  hotTopicId: '60d5ec9f8b8c6d1e8c8d7e8a'
}
```

### 3. 更新内容

```
PATCH /api/content/:id
```

**请求体**:
```json
{
  "title": "更新后的标题",
  "content": "更新后的内容"
}
```

### 4. 删除内容

```
DELETE /api/content/:id
```

## 前端组件

### 1. Content Generation Page

**主要功能**:
- 内容类型选择
- 生成参数表单
- 内容预览
- 编辑功能
- 重新生成

**关键代码**:
```jsx
const ContentGeneration = () => {
  const [selectedType, setSelectedType] = useState('article');
  const [formData, setFormData] = useState(null);
  const [generatedContent, setGeneratedContent] = useState(null);

  const generateMutation = useMutation({
    mutationFn: async ({ formData, type }) => {
      return await api.generateContent(formData, type);
    },
    onSuccess: (data) => {
      setGeneratedContent(data);
      toast.success('内容生成成功');
    }
  });

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
      {/* 左侧：生成配置 */}
      <div className="lg:col-span-2">
        <ContentTypeSelector
          types={contentTypes}
          selectedType={selectedType}
          onSelect={setSelectedType}
        />
        <GenerationForm
          selectedType={selectedType}
          onSubmit={handleGenerate}
        />
      </div>

      {/* 右侧：内容预览 */}
      <div>
        <ContentPreview
          content={generatedContent}
          onEdit={handleEdit}
          onSave={handleSave}
        />
      </div>
    </div>
  );
};
```

### 2. ContentTypeSelector Component

**主要功能**:
- 展示内容类型选项
- 高亮选中类型
- 显示类型描述

**关键代码**:
```jsx
const ContentTypeSelector = ({ types, selectedType, onSelect }) => {
  return (
    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
      {types.map((type) => (
        <Card
          key={type.id}
          className={`cursor-pointer transition-all ${
            selectedType === type.id
              ? 'ring-2 ring-primary'
              : 'hover:ring-1 hover:ring-primary/50'
          }`}
          onClick={() => onSelect(type.id)}
        >
          <CardContent className="pt-6">
            <type.icon className={`h-8 w-8 mb-2 text-${type.color}-500`} />
            <h3 className="font-semibold mb-1">{type.name}</h3>
            <p className="text-sm text-muted-foreground">{type.description}</p>
          </CardContent>
        </Card>
      ))}
    </div>
  );
};
```

### 3. GenerationForm Component

**主要功能**:
- 表单验证
- 参数配置
- 提交生成

**关键代码**:
```jsx
const GenerationForm = ({ selectedType, onSubmit }) => {
  const { handleSubmit, control } = useForm({
    defaultValues: {
      title: '',
      keywords: '',
      targetAudience: '',
      tone: 'professional',
      length: 'medium',
      includeData: true,
      includeCase: false,
      includeExpert: false
    }
  });

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <FormField
        control={control}
        name="title"
        label="内容标题"
        required
      />
      <FormField
        control={control}
        name="keywords"
        label="关键词"
        placeholder="用逗号分隔"
      />
      <FormField
        control={control}
        name="targetAudience"
        label="目标受众"
      />
      <FormField
        control={control}
        name="tone"
        label="内容风格"
        type="select"
        options={[
          { value: 'professional', label: '专业' },
          { value: 'casual', label: '轻松' },
          { value: 'emotional', label: '情感' }
        ]}
      />
      <Button type="submit" className="w-full">
        <Wand2 className="mr-2 h-4 w-4" />
        开始生成
      </Button>
    </form>
  );
};
```

### 4. ContentPreview Component

**主要功能**:
- 展示生成的内容
- 显示质量评分
- 显示优化建议
- 提供编辑功能

**关键代码**:
```jsx
const ContentPreview = ({ content, onEdit, onSave }) => {
  if (!content) {
    return (
      <Card>
        <CardContent className="flex items-center justify-center h-96">
          <p className="text-muted-foreground">暂无生成内容</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <div className="flex justify-between items-start">
          <div>
            <CardTitle>{content.title}</CardTitle>
            <Badge variant={content.quality >= 80 ? 'default' : 'secondary'}>
              质量评分: {content.quality}
            </Badge>
          </div>
        </div>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          <div>
            <h4 className="font-semibold mb-2">内容</h4>
            <Textarea
              value={content.content}
              onChange={(e) => onEdit({ ...content, content: e.target.value })}
              className="min-h-[400px]"
            />
          </div>

          {content.suggestions && content.suggestions.length > 0 && (
            <div>
              <h4 className="font-semibold mb-2">优化建议</h4>
              <ul className="list-disc list-inside space-y-1">
                {content.suggestions.map((suggestion, index) => (
                  <li key={index} className="text-sm text-muted-foreground">
                    {suggestion}
                  </li>
                ))}
              </ul>
            </div>
          )}

          <div className="flex space-x-2">
            <Button onClick={() => onSave(content)}>
              <Save className="mr-2 h-4 w-4" />
              保存
            </Button>
            <Button variant="outline" onClick={handleRegenerate}>
              <RotateCcw className="mr-2 h-4 w-4" />
              重新生成
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};
```

## 性能优化

### 1. 结果缓存

相同的生成参数可以缓存结果：

```javascript
const cacheKey = `generated:${type}:${JSON.stringify(params)}`;
const cached = await cache.get(cacheKey);
if (cached) return cached;
```

### 2. 并行生成

对于批量生成场景，可以并行调用：

```javascript
const results = await Promise.all([
  generateContent(params1),
  generateContent(params2),
  generateContent(params3)
]);
```

### 3. 流式输出

对于长内容，使用流式输出：

```javascript
const stream = await openai.chat.completions.create({
  ...params,
  stream: true
});

for await (const chunk of stream) {
  const content = chunk.choices[0]?.delta?.content;
  if (content) {
    processChunk(content);
  }
}
```

## 错误处理

### 常见错误

| 错误类型 | 处理方式 |
|----------|----------|
| API Key 无效 | 提示用户检查配置 |
| 配额不足 | 提示用户升级计划 |
| 网络超时 | 自动重试 3 次 |
| 模型错误 | 切换到备用模型 |
| 生成失败 | 返回详细错误信息 |

### 重试策略

```javascript
async function generateWithRetry(prompt, options, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await multiAIService.generateContent(prompt, options);
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await sleep(1000 * Math.pow(2, i)); // 指数退避
    }
  }
}
```

## 扩展规划

### 短期

- [ ] 优化提示词模板
- [ ] 添加更多内容类型
- [ ] 改进质量评估算法

### 中期

- [ ] 支持自定义风格
- [ ] 实现内容个性化
- [ ] 添加历史版本管理

### 长期

- [ ] 构建内容风格模型
- [ ] 实现智能选题
- [ ] 支持多语言生成
