# 用户认证模块

## 概述

用户认证模块负责系统的用户身份验证和权限管理，确保只有授权用户才能访问系统功能。该模块使用 JWT（JSON Web Token）进行无状态认证，提供安全的用户会话管理。

## 模块架构

```
用户认证模块
├── 认证层
│   ├── 用户登录
│   ├── Token 生成
│   ├── Token 验证
│   └── Token 刷新
├── 权限层
│   ├── 角色管理
│   ├── 权限控制
│   └── 路由守卫
├── 安全层
│   ├── 密码加密
│   ├── 密码验证
│   ├── 登录限流
│   └── 会话管理
├── 数据存储层
│   ├── 用户信息存储
│   └── 会话记录存储
└── 服务接口层
    ├── 登录 API
    ├── 登出 API
    └── 用户信息 API
```

## 核心文件

### 1. Auth Router

**文件**: `server/routes/auth.js`

**职责**: 提供认证相关的 REST API 接口。

**主要功能**:
- 用户登录
- 获取用户信息
- Token 验证中间件

### 2. Auth Middleware

**文件**: `server/utils/auth.js`

**职责**: 提供 JWT 认证中间件。

**主要功能**:
- Token 验证
- 用户信息提取
- 权限检查

## 数据模型

### 用户数据结构

```javascript
{
  _id: ObjectId,
  username: String,        // 用户名
  password: String,        // 加密后的密码
  role: String,          // 角色：admin/user
  createdAt: Date,
  updatedAt: Date
}
```

## API 接口

### 1. 用户登录

```
POST /api/auth/login
```

**请求体**:
```json
{
  "username": "admin",
  "password": "admin123"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "admin",
      "username": "admin",
      "role": "admin"
    }
  }
}
```

### 2. 获取用户信息

```
GET /api/auth/me
```

**请求头**:
```
Authorization: Bearer <token>
```

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "admin",
    "username": "admin",
    "role": "admin"
  }
}
```

## 认证流程

### 登录流程

```
用户输入用户名和密码
    ↓
提交登录请求
    ↓
验证用户名和密码
    ↓
密码加密比对
    ↓
验证成功？
    ↓
    是：生成 JWT Token
        ↓
    返回 Token 和用户信息
        ↓
    否：返回错误
```

### 认证流程

```
前端发送请求
    ↓
携带 JWT Token
    ↓
认证中间件验证
    ↓
Token 有效？
    ↓
    是：提取用户信息
        ↓
    继续处理请求
        ↓
    否：返回 401 未授权
```

## 安全机制

### 1. 密码加密

使用 bcryptjs 加密密码：

```javascript
const bcrypt = require('bcryptjs');

// 加密密码
const hashedPassword = await bcrypt.hash(password, 10);

// 验证密码
const isValid = await bcrypt.compare(password, hashedPassword);
```

### 2. JWT Token

生成和验证 JWT：

```javascript
const jwt = require('jsonwebtoken');

// 生成 Token
const token = jwt.sign(
  { userId: user.id, role: user.role },
  process.env.JWT_SECRET,
  { expiresIn: '24h' }
);

// 验证 Token
const decoded = jwt.verify(token, process.env.JWT_SECRET);
```

### 3. 登录限流

防止暴力破解：

```javascript
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 分钟
  max: 5, // 最多 5 次登录尝试
  message: '登录尝试次数过多，请稍后再试'
});

app.use('/api/auth/login', loginLimiter);
```

### 4. Token 过期

Token 设置过期时间：

```javascript
const token = jwt.sign(
  payload,
  secret,
  { expiresIn: '24h' } // 24 小时后过期
);
```

## 前端集成

### 1. Token 存储

```javascript
// 存储 Token
localStorage.setItem('token', token);

// 读取 Token
const token = localStorage.getItem('token');

// 删除 Token
localStorage.removeItem('token');
```

### 2. 请求拦截器

```javascript
import axios from 'axios';

const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL
});

// 请求拦截器
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// 响应拦截器
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Token 过期，跳转到登录页
      localStorage.removeItem('token');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);
```

### 3. 路由守卫

```javascript
const ProtectedRoute = ({ children }) => {
  const token = localStorage.getItem('token');

  if (!token) {
    return <Navigate to="/login" replace />;
  }

  return children;
};

// 使用
<Route path="/dashboard" element={
  <ProtectedRoute>
    <Dashboard />
  </ProtectedRoute>
} />
```

## 权限管理

### 角色定义

| 角色 | 权限 |
|------|------|
| admin | 所有权限 |
| user | 基本权限 |

### 权限检查

```javascript
function checkPermission(userRole, requiredRole) {
  const roles = {
    admin: 3,
    user: 1
  };

  return roles[userRole] >= roles[requiredRole];
}

// 使用中间件
function requireRole(role) {
  return (req, res, next) => {
    if (!checkPermission(req.user.role, role)) {
      return res.status(403).json({
        success: false,
        message: '权限不足'
      });
    }
    next();
  };
}

// 应用到路由
router.post('/admin/action',
  requireRole('admin'),
  async (req, res) => {
    // 需要管理员权限
  }
);
```

## 错误处理

### 常见错误

| 错误类型 | 说明 | HTTP 状态码 |
|----------|------|------------|
| AUTH_001 | 用户名或密码错误 | 401 |
| AUTH_002 | Token 无效或已过期 | 401 |
| AUTH_003 | 权限不足 | 403 |
| AUTH_004 | 登录尝试次数过多 | 429 |

### 错误响应

```json
{
  "success": false,
  "message": "用户名或密码错误",
  "code": "AUTH_001"
}
```

## 最佳实践

### 1. 安全存储

- 不要在前端存储敏感信息
- Token 存储在 localStorage 或 sessionStorage
- 不要在 URL 中传递 Token

### 2. HTTPS

生产环境必须使用 HTTPS，防止 Token 被窃取。

### 3. Token 刷新

实现 Token 刷新机制，避免频繁登录。

### 4. 登出

提供安全登出功能，清除客户端 Token。

## 扩展规划

### 短期

- [ ] 添加用户注册功能
- [ ] 实现密码重置
- [ ] 添加双因素认证

### 中期

- [ ] 支持第三方登录
- [ ] 实现用户分组
- [ ] 添加操作日志

### 长期

- [ ] 构建权限管理系统
- [ ] 实现 OAuth 2.0
- [ ] 支持单点登录（SSO）
