# 数据分析模块

## 概述

数据分析模块负责收集、聚合和展示内容在各平台的表现数据，提供多维度的数据分析和可视化，帮助用户了解内容效果，优化创作策略。该模块是系统的"眼睛"，让用户能够清楚地看到内容的表现情况。

## 模块架构

```
数据分析模块
├── 数据采集层
│   ├── 平台数据抓取
│   ├── 指标更新定时任务
│   └── 数据增量同步
├── 数据聚合层
│   ├── 时间维度聚合
│   ├── 平台维度聚合
│   ├── 内容维度聚合
│   └── 指标计算
├── 数据存储层
│   ├── MongoDB 存储
│   └── Redis 缓存
├── 可视化层
│   ├── 趋势图表
│   ├── 平台对比图表
│   ├── 分布饼图
│   └── 热门内容列表
└── 服务接口层
    ├── 总览数据 API
    ├── 内容统计 API
    ├── 平台表现 API
    └── 热门内容 API
```

## 核心文件

### 1. Analytics Router

**文件**: `server/routes/analytics.js`

**职责**: 提供数据分析的 REST API 接口。

**主要功能**:
- 获取总览数据
- 获取内容统计
- 获取平台表现
- 获取热门内容
- 计算增长指标

### 2. Analytics Page

**文件**: `src/pages/Analytics.jsx`

**职责**: 前端数据分析页面。

**主要功能**:
- 总览数据展示
- 趋势图表展示
- 平台对比展示
- 热门内容列表
- 时间范围选择

## 数据流程

### 数据采集流程

```
定时任务（每小时）
    ↓
遍历已发布内容
    ↓
调用平台数据接口
    ├── 获取浏览量
    ├── 获取点赞数
    ├── 获取评论数
    └── 获取分享数
    ↓
更新到数据库
    ↓
计算增长率
    ↓
缓存到 Redis
```

### 数据查询流程

```
前端请求数据
    ↓
检查 Redis 缓存
    ↓
缓存命中？
    ↓
    是：直接返回缓存数据
    ↓
    否：聚合计算
        ↓
    更新 Redis 缓存
        ↓
    返回数据
```

## API 接口

### 1. 获取总览数据

```
GET /api/analytics/overview
```

**响应**:
```json
{
  "success": true,
  "data": {
    "totalHotTopics": 156,
    "totalContents": 89,
    "totalPublished": 45,
    "totalViews": 100000,
    "totalLikes": 5000,
    "todayHotTopics": 12,
    "todayGenerated": 8,
    "todayPublished": 5,
    "platformDistribution": [
      { "platform": "toutiao", "count": 30, "percentage": 67 },
      { "platform": "weibo", "count": 15, "percentage": 33 }
    ],
    "contentTypeDistribution": [
      { "type": "article", "count": 40, "percentage": 45 },
      { "type": "micro", "count": 30, "percentage": 34 },
      { "type": "video", "count": 19, "percentage": 21 }
    ]
  }
}
```

### 2. 获取内容统计

```
GET /api/analytics/content
```

**查询参数**:
```javascript
{
  startDate: '2024-02-01',
  endDate: '2024-02-14',
  groupBy: 'day'
}
```

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "date": "2024-02-14",
      "generated": 10,
      "published": 5,
      "views": 2000,
      "likes": 100,
      "comments": 20,
      "shares": 10
    }
  ]
}
```

### 3. 获取平台表现

```
GET /api/analytics/platforms
```

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "platform": "toutiao",
      "totalPublished": 30,
      "totalViews": 80000,
      "avgViews": 2667,
      "totalLikes": 4000,
      "avgLikes": 133,
      "totalComments": 400,
      "avgComments": 13,
      "totalShares": 150,
      "avgShares": 5,
      "engagementRate": 5.75
    }
  ]
}
```

### 4. 获取热门内容

```
GET /api/analytics/top-content
```

**查询参数**:
```javascript
{
  limit: 10,
  sortBy: 'views'
}
```

## 前端组件

### 1. Analytics Page

**主要功能**:
- 总览数据卡片
- 时间范围选择
- 数据刷新
- 数据导出

**关键代码**:
```jsx
const Analytics = () => {
  const [dateRange, setDateRange] = useState('7d');

  const { data: overview } = useQuery({
    queryKey: ['analytics-overview'],
    queryFn: () => api.getAnalyticsOverview()
  });

  const { data: trendData } = useQuery({
    queryKey: ['analytics-trend', dateRange],
    queryFn: () => api.getAnalyticsContent(dateRange)
  });

  return (
    <div className="space-y-6">
      {/* 顶部操作栏 */}
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold">数据分析</h1>
        <div className="flex items-center space-x-2">
          <Select value={dateRange} onValueChange={setDateRange}>
            <SelectTrigger>
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="7d">最近7天</SelectItem>
              <SelectItem value="30d">最近30天</SelectItem>
              <SelectItem value="90d">最近90天</SelectItem>
            </SelectContent>
          </Select>
          <Button variant="outline">
            <Download className="mr-2 h-4 w-4" />
            导出数据
          </Button>
        </div>
      </div>

      {/* 总览卡片 */}
      <OverviewCards data={overview} />

      {/* 趋势图表 */}
      <TrendChart data={trendData} />

      {/* 平台对比 */}
      <PlatformComparison data={overview?.platformDistribution} />

      {/* 热门内容 */}
      <TopContent />
    </div>
  );
};
```

### 2. OverviewCards Component

**主要功能**:
- 展示关键指标
- 显示增长率
- 今日数据对比

**关键代码**:
```jsx
const OverviewCards = ({ data }) => {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <Card>
        <CardContent className="p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-muted-foreground">
                今日热点
              </p>
              <p className="text-2xl font-bold mt-1">
                {data?.todayHotTopics}
              </p>
            </div>
            <TrendingUp className="h-8 w-8 text-green-600" />
          </div>
          <p className="text-xs text-muted-foreground mt-2">
            总计: {data?.totalHotTopics}
          </p>
        </CardContent>
      </Card>

      <Card>
        <CardContent className="p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-muted-foreground">
                今日生成
              </p>
              <p className="text-2xl font-bold mt-1">
                {data?.todayGenerated}
              </p>
            </div>
            <FileText className="h-8 w-8 text-blue-600" />
          </div>
          <p className="text-xs text-muted-foreground mt-2">
            总计: {data?.totalContents}
          </p>
        </CardContent>
      </Card>

      {/* 更多卡片... */}
    </div>
  );
};
```

### 3. TrendChart Component

**主要功能**:
- 展示趋势数据
- 支持多指标切换
- 交互式图表

**关键代码**:
```jsx
const TrendChart = ({ data }) => {
  const [metric, setMetric] = useState('views');

  return (
    <Card>
      <CardHeader>
        <div className="flex justify-between items-center">
          <CardTitle>趋势分析</CardTitle>
          <Select value={metric} onValueChange={setMetric}>
            <SelectTrigger>
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="views">浏览量</SelectItem>
              <SelectItem value="likes">点赞数</SelectItem>
              <SelectItem value="comments">评论数</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={300}>
          <LineChart data={data}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="date" />
            <YAxis />
            <Tooltip />
            <Legend />
            <Line
              type="monotone"
              dataKey={metric}
              stroke="#8884d8"
              strokeWidth={2}
            />
          </LineChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
};
```

### 4. PlatformComparison Component

**主要功能**:
- 平台发布数量对比
- 平台数据指标对比
- 饼图展示

**关键代码**:
```jsx
const PlatformComparison = ({ data }) => {
  return (
    <Card>
      <CardHeader>
        <CardTitle>平台对比</CardTitle>
      </CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={300}>
          <PieChart>
            <Pie
              data={data}
              dataKey="count"
              nameKey="platform"
              label={({ name, percentage }) => `${name} ${percentage}%`}
            >
              {data.map((entry, index) => (
                <Cell
                  key={`cell-${index}`}
                  fill={COLORS[index % COLORS.length]}
                />
              ))}
            </Pie>
            <Tooltip />
            <Legend />
          </PieChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
};
```

### 5. TopContent Component

**主要功能**:
- 展示热门内容
- 显示数据指标
- 支持排序

**关键代码**:
```jsx
const TopContent = () => {
  const { data } = useQuery({
    queryKey: ['analytics-top-content'],
    queryFn: () => api.getTopContent({ limit: 10, sortBy: 'views' })
  });

  return (
    <Card>
      <CardHeader>
        <CardTitle>热门内容</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {data?.map((content, index) => (
            <div key={content._id} className="flex items-center space-x-4">
              <div className="text-2xl font-bold text-gray-400">
                {index + 1}
              </div>
              <div className="flex-1">
                <h3 className="font-semibold">{content.title}</h3>
                <p className="text-sm text-muted-foreground">
                  浏览: {content.views} | 点赞: {content.likes}
                </p>
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
};
```

## 性能优化

### 1. 缓存策略

```javascript
// 缓存总览数据
await redis.setex(
  'analytics:overview',
  300, // 5分钟
  JSON.stringify(overview)
);

// 缓存趋势数据
await redis.setex(
  `analytics:trend:${dateRange}`,
  600, // 10分钟
  JSON.stringify(trendData)
);
```

### 2. 分页加载

大数据集使用分页：

```javascript
const page = parseInt(req.query.page) || 1;
const limit = parseInt(req.query.limit) || 20;

const data = await PublishRecord.find()
  .skip((page - 1) * limit)
  .limit(limit);
```

### 3. 聚合优化

使用 MongoDB 的聚合管道：

```javascript
const stats = await PublishRecord.aggregate([
  { $match: { status: 'success' } },
  {
    $group: {
      _id: '$platform',
      total: { $sum: 1 },
      totalViews: { $sum: '$metrics.views' }
    }
  }
]);
```

### 4. 增量更新

只更新有变化的数据：

```javascript
async function incrementallyUpdate() {
  const records = await PublishRecord.find({
    updatedAt: { $gte: lastUpdateTime }
  });

  for (const record of records) {
    const metrics = await fetchMetrics(record.platformUrl);
    await PublishRecord.findByIdAndUpdate(record._id, { metrics });
  }
}
```

## 数据导出

### 导出格式

支持以下格式：
- CSV
- Excel
- JSON

### 导出接口

```
GET /api/analytics/export
```

**查询参数**:
```javascript
{
  format: 'csv',
  startDate: '2024-02-01',
  endDate: '2024-02-14'
}
```

## 扩展规划

### 短期

- [ ] 添加更多数据指标
- [ ] 优化图表展示
- [ ] 支持数据导出

### 中期

- [ ] 实现数据对比功能
- [ ] 添加自定义报表
- [ ] 支持数据预警

### 长期

- [ ] 构建数据预测模型
- [ ] 实现智能推荐
- [ ] 支持多租户分析
