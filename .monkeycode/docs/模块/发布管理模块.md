# 发布管理模块

## 概述

发布管理模块负责将生成的内容自动发布到各大平台，实现内容的多渠道分发。该模块支持立即发布和定时发布，提供发布状态跟踪和数据指标更新，确保内容能够高效、准确地分发到目标平台。

## 模块架构

```
发布管理模块
├── 平台适配层
│   ├── 今日头条服务
│   ├── 微博服务（规划中）
│   ├── 微信公众号服务（规划中）
│   ├── 抖音服务（规划中）
│   └── 小红书服务（规划中）
├── 内容适配层
│   ├── 格式转换
│   ├── 图片处理
│   ├── 标签处理
│   └── 长度控制
├── 发布控制层
│   ├── 立即发布
│   ├── 定时发布
│   ├── 批量发布
│   └── 发布队列管理
├── 状态管理层
│   ├── 状态跟踪
│   ├── 实时更新
│   └── 错误处理
├── 数据采集层
│   ├── 指标更新
│   ├── 数据聚合
│   └── 增量同步
└── 服务接口层
    ├── 发布到平台 API
    ├── 获取发布队列 API
    ├── 获取发布历史 API
    └── 获取发布统计 API
```

## 核心文件

### 1. PublishRecord Model

**文件**: `server/models/PublishRecord.js`

**职责**: 定义发布记录的数据模型和索引。

**主要功能**:
- Schema 定义
- 状态管理
- 指标存储
- 索引创建

### 2. Toutiao Service

**文件**: `server/services/toutiaoService.js`

**职责**: 今日头条平台的具体发布实现。

**主要功能**:
- 发布文章
- 发布微头条
- 内容类型映射
- 封面图生成
- 发布状态查询
- 数据指标更新

### 3. Publish Router

**文件**: `server/routes/publish.js`

**职责**: 提供 REST API 接口。

**主要功能**:
- 发布到平台
- 获取发布队列
- 获取发布历史
- 更新发布状态
- 获取发布统计

### 4. Publishing Page

**文件**: `src/pages/Publishing.jsx`

**职责**: 前端发布管理页面。

**主要功能**:
- 发布队列展示
- 发布历史查看
- 发布状态跟踪
- 平台数据统计

## 数据流程

### 发布流程

```
用户选择内容并点击发布
    ↓
创建发布记录（status: pending）
    ↓
调用平台服务
    ├── 请求参数封装
    ├── 签名/认证
    └── 发送请求
    ↓
解析响应
    ├── 成功：更新记录为 success
    ├── 失败：更新记录为 failed
    └── 保存平台 URL
    ↓
更新内容状态（status: published）
    ↓
返回结果给前端
    ↓
定时任务更新数据指标
```

### 指标更新流程

```
定时任务（每小时）
    ↓
遍历已发布内容
    ↓
调用平台数据接口
    ├── 获取浏览量
    ├── 获取点赞数
    ├── 获取评论数
    └── 获取分享数
    ↓
更新到数据库
    ↓
计算增长率
    ↓
缓存到 Redis
```

## API 接口

### 1. 发布到今日头条

```
POST /api/publish/toutiao
```

**请求体**:
```json
{
  "contentId": "60d5ec9f8b8c6d1e8c8d7e8b",
  "scheduledTime": "2024-02-15T10:00:00Z"
}
```

**响应**:
```json
{
  "success": true,
  "message": "发布成功",
  "data": {
    "publishRecord": {
      "_id": "60d5ec9f8b8c6d1e8c8d7e8c",
      "contentId": "60d5ec9f8b8c6d1e8c8d7e8b",
      "platform": "toutiao",
      "status": "success",
      "platformUrl": "https://www.toutiao.com/article/123456/",
      "publishTime": "2024-02-14T11:00:00Z"
    },
    "platformUrl": "https://www.toutiao.com/article/123456/"
  }
}
```

### 2. 获取发布队列

```
GET /api/publish/queue
```

**查询参数**:
```javascript
{
  page: 1,
  limit: 20,
  status: 'pending'
}
```

### 3. 获取发布历史

```
GET /api/publish/history
```

**查询参数**:
```javascript
{
  page: 1,
  limit: 20,
  platform: 'toutiao'
}
```

### 4. 获取发布统计

```
GET /api/publish/stats
```

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "_id": "toutiao",
      "total": 50,
      "success": 45,
      "failed": 5,
      "totalViews": 100000,
      "totalLikes": 5000,
      "totalComments": 500,
      "totalShares": 200
    }
  ]
}
```

## 前端组件

### 1. Publishing Page

**主要功能**:
- 发布队列展示
- 发布历史查看
- 平台统计展示
- 状态过滤

**关键代码**:
```jsx
const Publishing = () => {
  const [activeTab, setActiveTab] = useState('queue');

  const { data: queueData } = useQuery({
    queryKey: ['publish-queue'],
    queryFn: () => api.getPublishQueue()
  });

  const { data: historyData } = useQuery({
    queryKey: ['publish-history'],
    queryFn: () => api.getPublishHistory()
  });

  return (
    <div>
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList>
          <TabsTrigger value="queue">发布队列</TabsTrigger>
          <TabsTrigger value="history">发布历史</TabsTrigger>
          <TabsTrigger value="stats">平台统计</TabsTrigger>
        </TabsList>

        <TabsContent value="queue">
          <PublishQueue records={queueData?.data} />
        </TabsContent>

        <TabsContent value="history">
          <PublishHistory records={historyData?.data} />
        </TabsContent>

        <TabsContent value="stats">
          <PlatformStats stats={statsData?.data} />
        </TabsContent>
      </Tabs>
    </div>
  );
};
```

### 2. PublishQueue Component

**主要功能**:
- 展示待发布内容
- 显示定时发布时间
- 取消发布功能

**关键代码**:
```jsx
const PublishQueue = ({ records }) => {
  return (
    <div className="space-y-4">
      {records?.map((record) => (
        <Card key={record._id}>
          <CardContent className="flex items-center justify-between p-4">
            <div className="flex-1">
              <h4 className="font-semibold">{record.contentId?.title}</h4>
              <p className="text-sm text-muted-foreground">
                {record.scheduledTime
                  ? `定时发布: ${formatDate(record.scheduledTime)}`
                  : '等待发布'}
              </p>
            </div>
            <div className="flex items-center space-x-2">
              <Badge variant="outline">{record.platform}</Badge>
              <Button
                variant="outline"
                size="sm"
                onClick={() => handleCancel(record._id)}
              >
                取消
              </Button>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
};
```

### 3. PublishHistory Component

**主要功能**:
- 展示已发布内容
- 显示平台链接
- 查看数据指标

**关键代码**:
```jsx
const PublishHistory = ({ records }) => {
  return (
    <div className="space-y-4">
      {records?.map((record) => (
        <Card key={record._id}>
          <CardContent className="p-4">
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <h4 className="font-semibold mb-2">
                  {record.contentId?.title}
                </h4>
                <div className="flex items-center space-x-4 text-sm text-muted-foreground">
                  <span>平台: {record.platform}</span>
                  <span>
                    发布时间: {formatDate(record.publishTime)}
                  </span>
                  <a
                    href={record.platformUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-primary hover:underline"
                  >
                    查看原文
                  </a>
                </div>
                <div className="flex items-center space-x-4 mt-2">
                  <span>浏览: {record.metrics.views}</span>
                  <span>点赞: {record.metrics.likes}</span>
                  <span>评论: {record.metrics.comments}</span>
                  <span>分享: {record.metrics.shares}</span>
                </div>
              </div>
              <Badge
                variant={record.status === 'success' ? 'default' : 'destructive'}
              >
                {record.status}
              </Badge>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
};
```

### 4. PlatformStats Component

**主要功能**:
- 平台发布统计
- 成功率展示
- 数据指标对比

**关键代码**:
```jsx
const PlatformStats = ({ stats }) => {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      {stats?.map((stat) => (
        <Card key={stat._id}>
          <CardHeader>
            <CardTitle>{stat._id}</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div>
                <p className="text-sm text-muted-foreground">发布总数</p>
                <p className="text-2xl font-bold">{stat.total}</p>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-muted-foreground">成功</p>
                  <p className="text-xl font-bold text-green-600">
                    {stat.success}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">失败</p>
                  <p className="text-xl font-bold text-red-600">
                    {stat.failed}
                  </p>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-muted-foreground">总浏览</p>
                  <p className="text-xl font-bold">{stat.totalViews}</p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">总点赞</p>
                  <p className="text-xl font-bold">{stat.totalLikes}</p>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-muted-foreground">总评论</p>
                  <p className="text-xl font-bold">{stat.totalComments}</p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">总分享</p>
                  <p className="text-xl font-bold">{stat.totalShares}</p>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
};
```

## 性能优化

### 1. 批量操作

使用平台批量接口，减少 API 调用次数。

### 2. 异步处理

发布操作异步执行，提升响应速度。

```javascript
async function publishAsync(contentId, platform) {
  // 创建发布记录
  const record = await PublishRecord.create({
    contentId,
    platform,
    status: 'pending'
  });

  // 异步执行发布
  setImmediate(async () => {
    try {
      const result = await publishToPlatform(contentId, platform);
      await PublishRecord.findByIdAndUpdate(record._id, {
        status: 'success',
        platformUrl: result.url
      });
    } catch (error) {
      await PublishRecord.findByIdAndUpdate(record._id, {
        status: 'failed',
        failReason: error.message
      });
    }
  });

  return record;
}
```

### 3. 队列管理

使用消息队列管理发布任务，保证可靠性。

### 4. 结果缓存

缓存发布结果，避免重复查询。

## 错误处理

### 常见错误

| 错误类型 | 处理方式 |
|----------|----------|
| AUTH_FAILED | 提示重新授权 |
| CONTENT_INVALID | 提示修改内容 |
| RATE_LIMITED | 延迟重试 |
| NETWORK_ERROR | 自动重试 |
| API_ERROR | 记录日志，通知用户 |

### 重试策略

```javascript
async function publishWithRetry(content, platform, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await publishToPlatform(content, platform);
    } catch (error) {
      if (error.code === 'AUTH_FAILED') break;
      if (i === maxRetries - 1) throw error;
      await sleep(1000 * Math.pow(2, i));
    }
  }
}
```

## 扩展规划

### 短期

- [ ] 完成今日头条发布集成
- [ ] 优化发布流程
- [ ] 添加发布模板

### 中期

- [ ] 支持微博发布
- [ ] 支持微信公众号发布
- [ ] 支持抖音发布

### 长期

- [ ] 支持小红书发布
- [ ] 构建平台分发策略
- [ ] 实现智能推荐发布时间
