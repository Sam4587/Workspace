# 热点监控模块

## 概述

热点监控模块是 AI 内容创作系统的核心数据源模块，负责实时抓取、处理和存储各大平台的热门话题。该模块为内容生成提供素材来源，是整个系统的数据入口。

## 模块架构

```
热点监控模块
├── 数据源层
│   ├── 微博热搜 API
│   ├── 今日头条页面抓取
│   └── 百度热搜页面抓取
├── 数据处理层
│   ├── 数据标准化
│   ├── 分类识别
│   ├── 关键词提取
│   ├── 适配度评分
│   └── 趋势分析
├── 数据存储层
│   ├── MongoDB 存储
│   └── Redis 缓存
└── 服务接口层
    ├── 热点列表 API
    ├── 热点详情 API
    └── 热点更新 API
```

## 核心文件

### 1. HotTopic Model

**文件**: `server/models/HotTopic.js`

**职责**: 定义热点话题的数据模型和索引。

**主要功能**:
- Schema 定义
- 数据验证
- 索引创建

### 2. HotTopic Service

**文件**: `server/services/hotTopicService.js`

**职责**: 热点数据的抓取、处理和更新。

**主要功能**:
- 抓取微博热搜
- 抓取今日头条热点
- 抓取百度热搜
- 数据清洗和分类
- 关键词提取
- 适配度评分
- 批量更新数据库

### 3. Hot Topics Router

**文件**: `server/routes/hotTopics.js`

**职责**: 提供 REST API 接口。

**主要功能**:
- 获取热点列表（分页、筛选、排序）
- 获取热点详情
- 触发热点更新
- 热点搜索

### 4. Hot Topics Page

**文件**: `src/pages/HotTopics.jsx`

**职责**: 前端热点监控页面。

**主要功能**:
- 热点列表展示
- 热点搜索和筛选
- 热点详情查看
- 一键生成内容

## 数据流程

### 抓取流程

```
定时任务触发（每30分钟）
    ↓
遍历所有数据源
    ↓
并行抓取数据
    ├── fetchWeiboHotSearch()
    ├── fetchToutiaoHot()
    └── fetchBaiduHot()
    ↓
数据标准化
    ├── 统一字段格式
    ├── 提取关键词
    ├── 识别分类
    └── 计算适配度
    ↓
去重处理
    ├── 按标题去重
    └── 按来源去重
    ↓
批量更新 MongoDB
    └── findOneAndUpdate() with upsert
    ↓
更新 Redis 缓存
    └── setex(key, 1800, data)
```

### 查询流程

```
前端请求热点列表
    ↓
检查 Redis 缓存
    ↓
缓存命中？
    ↓
    是：直接返回缓存数据
    ↓
    否：查询 MongoDB
        ↓
    更新 Redis 缓存
        ↓
    返回数据
```

## API 接口

### 1. 获取热点列表

```
GET /api/hot-topics
```

**查询参数**:
```javascript
{
  page: 1,           // 页码
  limit: 20,         // 每页数量
  category: '科技',    // 分类筛选
  search: '人工智能',   // 搜索关键词
  minHeat: 80,        // 最小热度
  maxHeat: 100,       // 最大热度
  sortBy: 'heat',     // 排序字段
  sortOrder: 'desc'    // 排序方式
}
```

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "_id": "60d5ec9f8b8c6d1e8c8d7e8a",
      "title": "人工智能在医疗领域的应用",
      "description": "AI技术在医疗诊断中的应用越来越广泛",
      "category": "科技",
      "heat": 95,
      "trend": "up",
      "source": "微博热搜",
      "sourceUrl": "https://s.weibo.com/weibo?q=人工智能",
      "keywords": ["人工智能", "医疗", "AI"],
      "suitability": 88,
      "publishedAt": "2024-02-14T10:30:00Z",
      "createdAt": "2024-02-14T10:30:00Z",
      "updatedAt": "2024-02-14T10:30:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 156,
    "pages": 8
  }
}
```

### 2. 获取热点详情

```
GET /api/hot-topics/:id
```

### 3. 更新热点数据

```
POST /api/hot-topics/update
```

## 前端组件

### 1. HotTopics Page

**主要功能**:
- 热点列表展示
- 搜索和筛选
- 加载状态处理
- 分页导航

**关键代码**:
```jsx
const HotTopics = () => {
  const { data, isLoading } = useQuery({
    queryKey: ['hot-topics', filters],
    queryFn: () => api.getHotTopics(filters)
  });

  return (
    <div>
      {/* 搜索和筛选 */}
      <SearchAndFilter filters={filters} setFilters={setFilters} />

      {/* 热点列表 */}
      {isLoading ? <Skeleton /> : <TopicList topics={data?.data} />}

      {/* 分页 */}
      <Pagination pagination={data?.pagination} />
    </div>
  );
};
```

### 2. TopicCard Component

**主要功能**:
- 展示单个热点话题
- 显示适配度评分
- 一键生成内容按钮
- 跳转到详情页面

**关键代码**:
```jsx
const TopicCard = ({ topic }) => {
  const navigate = useNavigate();

  const handleGenerate = () => {
    navigate('/content-generation', {
      state: { selectedTopic: topic }
    });
  };

  return (
    <Card>
      <CardHeader>
        <div className="flex justify-between items-start">
          <div>
            <CardTitle>{topic.title}</CardTitle>
            <CardDescription>{topic.description}</CardDescription>
          </div>
          <Badge>{topic.category}</Badge>
        </div>
      </CardHeader>
      <CardContent>
        <div className="flex justify-between items-center">
          <div className="flex items-center space-x-4">
            <span>热度: {topic.heat}</span>
            <TrendIcon trend={topic.trend} />
            <span>适配度: {topic.suitability}</span>
          </div>
          <Button onClick={handleGenerate}>
            <Wand2 className="mr-2 h-4 w-4" />
            生成内容
          </Button>
        </div>
      </CardContent>
    </Card>
  );
};
```

## 性能优化

### 1. 并行抓取

使用 `Promise.all` 并行抓取多个数据源：

```javascript
async function updateHotTopics() {
  const [weibo, toutiao, baidu] = await Promise.all([
    fetchWeiboHotSearch(),
    fetchToutiaoHot(),
    fetchBaiduHot()
  ]);
  // ...
}
```

### 2. 批量更新

使用 MongoDB 的 `bulkWrite` 批量更新：

```javascript
const bulkOps = topics.map(topic => ({
  updateOne: {
    filter: { title: topic.title, source: topic.source },
    update: topic,
    upsert: true
  }
}));

await HotTopic.bulkWrite(bulkOps, { ordered: false });
```

### 3. 缓存策略

使用 Redis 缓存热点数据：

```javascript
// 缓存热点列表
await redis.setex(
  'hot-topics:list',
  1800, // 30分钟
  JSON.stringify(topics)
);

// 读取缓存
const cached = await redis.get('hot-topics:list');
if (cached) return JSON.parse(cached);
```

### 4. 索引优化

在关键字段上建立索引：

```javascript
hotTopicSchema.index({ heat: -1 });
hotTopicSchema.index({ category: 1, createdAt: -1 });
hotTopicSchema.index({ title: 'text', description: 'text' });
```

## 错误处理

### 常见错误

| 错误类型 | 处理方式 |
|----------|----------|
| 网络超时 | 自动重试 3 次 |
| 数据格式错误 | 记录日志，跳过该条数据 |
| 解析失败 | 使用备用解析策略 |
| 数据库错误 | 返回缓存数据 |

### 重试策略

```javascript
async function fetchWithRetry(fetchFn, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fetchFn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await sleep(1000 * (i + 1)); // 指数退避
    }
  }
}
```

## 监控指标

### 关键指标

- 抓取成功率
- 抓取耗时
- 数据质量（去重率、分类准确率）
- 缓存命中率

### 告警规则

- 抓取成功率低于 80% 时告警
- 抓取耗时超过 30 秒时告警
- 数据质量异常时告警

## 扩展规划

### 短期

- [ ] 添加更多数据源（知乎、B站、抖音）
- [ ] 优化分类算法，提高准确率
- [ ] 添加话题相似度推荐

### 中期

- [ ] 实现话题趋势预测
- [ ] 添加话题生命周期管理
- [ ] 支持自定义话题源

### 长期

- [ ] 构建话题知识图谱
- [ ] 实现智能话题推荐
- [ ] 支持多语言话题抓取
