# 系统架构

## 架构概述

AI 内容创作系统采用前后端分离的架构设计，基于微服务理念构建，支持横向扩展和高可用部署。

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                │
├─────────────────────────────────────────────────────────────────┤
│  Web 浏览器  │  移动端 H5  │  管理后台                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      前端应用层                              │
│  (React + Vite + TanStack Query + shadcn/ui)                 │
├─────────────────────────────────────────────────────────────────┤
│  总览页面  │  热点监控  │  内容生成  │  发布管理  │  数据分析 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                       API 网关层                             │
│                    (Nginx 反向代理)                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      后端应用层                              │
│                   (Express.js + Node.js)                       │
├─────────────────────────────────────────────────────────────────┤
│  认证路由  │  热点路由  │  内容路由  │  发布路由  │  分析路由 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      业务服务层                              │
├─────────────────────────────────────────────────────────────────┤
│  多AI服务  │  热点服务  │  发布服务  │  质量评估  │  数据服务  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      数据存储层                              │
├─────────────────────────────────────────────────────────────────┤
│  MongoDB (主数据)  │  Redis (缓存/限流)  │  文件存储 (图片) │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     外部服务层                              │
├─────────────────────────────────────────────────────────────────┤
│  OpenAI  │  百度AI  │  讯飞AI  │  今日头条  │  微博  │  微信公众号  │
└─────────────────────────────────────────────────────────────────┘
```

## 技术选型

### 前端技术栈

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| React | 18.2.0 | UI 框架 | 组件化开发，虚拟 DOM |
| Vite | 5.4.11 | 构建工具 | 快速热更新，优化的生产构建 |
| React Router | 6.23.1 | 路由管理 | 单页应用路由 |
| TanStack Query | 5.48.0 | 数据获取 | 服务端状态管理，自动缓存 |
| shadcn/ui | Latest | UI 组件库 | 基于 Radix UI，无样式依赖 |
| Tailwind CSS | 3.4.4 | CSS 框架 | 原子化 CSS，快速开发 |
| Framer Motion | 11.3.9 | 动画库 | 流畅的 UI 动画效果 |
| Recharts | 2.12.7 | 图表库 | 数据可视化 |
| Lucide React | 0.417.0 | 图标库 | 精美的 SVG 图标 |

### 后端技术栈

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| Node.js | 18+ | 运行时环境 | JavaScript 后端运行环境 |
| Express.js | 5.2.1 | Web 框架 | 轻量级 REST API 框架 |
| Mongoose | 9.1.5 | ODM | MongoDB 对象文档映射 |
| MongoDB | 6.0+ | 主数据库 | 文档型数据库，灵活的数据结构 |
| Redis | 7.0+ | 缓存/队列 | 高性能键值存储，支持限流 |
| PM2 | 6.0.14 | 进程管理 | Node.js 进程守护，自动重启 |
| Winston | 3.19.0 | 日志管理 | 结构化日志，多渠道输出 |
| node-cron | 4.2.1 | 定时任务 | 定时执行热点更新等任务 |
| rate-limiter-flexible | 9.0.1 | 限流 | API 访问频率限制 |

### AI 服务

| 服务 | 用途 | 说明 |
|------|------|------|
| OpenAI | 内容生成 | GPT-3.5/GPT-4 模型 |
| 百度 AI | 内容生成 | 文心一言模型 |
| 讯飞 AI | 内容生成 | 星火认知大模型 |
| 火山方舟 | 内容生成 | 备用 AI 模型 |

### 第三方平台

| 平台 | 集成状态 | 说明 |
|------|----------|------|
| 今日头条 | 开发中 | 内容发布 |
| 微博 | 规划中 | 内容发布 |
| 微信公众号 | 规划中 | 内容发布 |
| 抖音 | 规划中 | 内容发布 |
| 小红书 | 规划中 | 内容发布 |

## 数据流转

### 热点监控流程

```
定时任务 (每30分钟)
    ↓
热点服务 (hotTopicService)
    ↓
    ├── 微博热搜 API 调用
    ├── 今日头条页面抓取
    └── 百度热搜页面抓取
    ↓
数据清洗与分类
    ├── 关键词提取
    ├── 分类匹配
    ├── 适配度评分
    └── 趋势分析
    ↓
MongoDB 存储
    ↓
Redis 缓存更新
```

### 内容生成流程

```
用户选择热点话题
    ↓
填写生成参数
    ├── 内容类型 (长文章/微头条/视频脚本/音频脚本)
    ├── 标题与关键词
    ├── 目标受众
    ├── 内容风格
    └── 长度要求
    ↓
多 AI 服务调用
    ├── OpenAI 生成
    ├── 失败则切换百度 AI
    └── 再失败则切换讯飞 AI
    ↓
质量评估
    ├── 内容质量评分
    ├── 字数统计
    └── 优化建议生成
    ↓
内容预览与编辑
    ↓
保存到 MongoDB
```

### 发布流程

```
用户点击发布
    ↓
创建发布记录
    ↓
平台服务调用
    ├── 今日头条 API
    ├── 微博 API (规划中)
    └── 微信公众号 API (规划中)
    ↓
获取平台返回 URL
    ↓
更新发布记录状态
    ↓
定时更新数据指标
    ├── 浏览量
    ├── 点赞数
    ├── 评论数
    └── 分享数
```

### 数据分析流程

```
定时任务 (每小时)
    ↓
从各平台抓取数据指标
    ↓
聚合到 MongoDB
    ↓
计算统计指标
    ├── 总浏览量
    ├── 平均点赞率
    ├── 热门内容排行
    └── 平台表现对比
    ↓
Redis 缓存结果
    ↓
前端展示图表
```

## 核心模块

### 0. 模块化架构层 (TrendRadar 重构)

基于 TrendRadar 架构设计理念，重构后的模块化架构包含以下核心组件：

**数据来源层** (`server/fetchers/`)：
- `BaseFetcher.js` - 抽象基类，定义统一接口
- `WeiboFetcher.js` - 微博热搜数据获取
- `ToutiaoFetcher.js` - 今日头条数据获取
- `ZhihuFetcher.js` - 知乎热榜数据获取
- `RSSFetcher.js` - RSS 订阅源数据获取
- `FetcherManager.js` - 统一管理器，支持并行获取

**AI 智能层** (`server/ai/`)：
- `LiteLLMAdapter.js` - LiteLLM 适配器，支持 100+ AI 提供商
  - OpenAI (GPT-4, GPT-3.5)
  - Anthropic (Claude)
  - DeepSeek
  - Moonshot
  - 智谱 GLM
  - 通义千问
  - 百度文心
  - 讯飞星火

**通知层** (`server/notification/`)：
- `BaseSender.js` - 抽象发送器基类
- `senders/WeWorkSender.js` - 企业微信通知
- `senders/DingTalkSender.js` - 钉钉通知
- `senders/FeishuSender.js` - 飞书通知
- `NotificationDispatcher.js` - 多渠道统一调度

**报告生成层** (`server/reports/`)：
- `ReportGenerator.js` - 多格式报告生成
  - HTML 报告（内置模板）
  - Markdown 报告
  - 日报/周报/内容报告

**核心处理层** (`server/core/`)：
- `types.js` - 类型定义和常量
- `TopicAnalyzer.js` - 话题分析器
  - 分类功能
  - 关键词提取
  - 适配度评分
  - 情感分析
- `TrendAnalyzer.js` - 趋势分析器
  - 趋势预测
  - 生命周期分析
  - 相关话题挖掘
  - 爆发预测
- `StorageManager.js` - 存储管理器
  - MongoDB 操作封装
  - Redis 缓存管理
  - 数据模型定义

**MCP 服务器** (`server/mcp/`)：
- `main.py` - FastMCP 2.0 服务器
  - 热点话题获取工具
  - AI 内容生成工具
  - 多平台发布工具
  - 数据分析工具

### 1. 热点监控模块

**职责**：
- 实时抓取各大平台热门话题
- 数据清洗与分类
- 适配度评分
- 热点趋势分析
- 跨平台分析
- RSS 订阅源管理
- 推送通知管理

**核心文件**：
- `server/services/hotTopicService.js` - 热点抓取服务
- `server/models/HotTopic.js` - 热点数据模型
- `server/routes/hotTopics.js` - 热点 API 路由
- `src/pages/HotTopics.jsx` - 热点监控页面
- `src/components/TopicCard.jsx` - 话题卡片
- `src/components/FilterPanel.jsx` - 筛选面板
- `src/components/TrendTimeline.jsx` - 趋势时间线
- `src/components/AIAnalysisPanel.jsx` - AI 分析面板
- `src/components/CrossPlatformAnalysis.jsx` - 跨平台分析
- `src/components/HotTopicsPreview.jsx` - 热点预览

### 2. 内容生成模块

**职责**：
- AI 内容生成
- 内容编辑与预览
- 质量评估
- 草稿管理

**核心文件**：
- `server/services/multiAIService.js` - 多 AI 服务
- `server/services/aiService.js` - AI 服务封装
- `server/services/qualityAssessment.js` - 质量评估
- `server/models/Content.js` - 内容数据模型
- `server/routes/content.js` - 内容 API 路由
- `src/pages/ContentGeneration.jsx` - 内容生成页面
- `src/components/ContentTypeSelector.jsx` - 内容类型选择器
- `src/components/GenerationForm.jsx` - 生成表单
- `src/components/ContentPreview.jsx` - 内容预览

### 3. Prompt 模板管理模块

**职责**：
- Prompt 模板的创建、编辑、删除
- 模板变量管理
- 模板分类与标签
- 模板使用统计
- 模板渲染

**核心文件**：
- `server/services/promptTemplateService.js` - Prompt 模板服务
- `server/models/PromptTemplate.js` - 模板数据模型
- `src/lib/api.js` - 前端 API 调用

### 4. 发布管理模块

**职责**：
- 多平台内容发布
- 发布队列管理
- 发布状态跟踪
- 数据指标更新

**核心文件**：
- `server/services/toutiaoService.js` - 今日头条服务
- `server/models/PublishRecord.js` - 发布记录模型
- `server/routes/publish.js` - 发布 API 路由
- `src/pages/Publishing.jsx` - 发布管理页面

### 4. 数据分析模块

**职责**：
- 数据统计与聚合
- 图表展示
- 报表生成
- 数据导出
- 推荐洞察分析
- 内容优化建议
- 浏览量趋势分析
- 内容类型分布分析

**核心文件**：
- `server/routes/analytics.js` - 分析 API 路由
- `src/pages/Analytics.jsx` - 数据分析页面
- `src/components/StatsCard.jsx` - 统计卡片
- `src/components/RecentActivity.jsx` - 最近活动

### 5. 视频生成模块（基于 Remotion）

**职责**：
- 视频模板渲染
- 渲染队列管理
- TTS 语音合成
- 批量视频生成
- 实时预览

**核心文件**：
- `server/services/videoRenderService.js` - 视频渲染服务
- `server/services/videoQueue.js` - 渲染队列服务
- `server/services/ttsService.js` - TTS 语音服务
- `server/routes/video.js` - 视频 API 路由
- `src/pages/VideoGeneration.jsx` - 视频生成页面
- `src/components/video/ArticleVideo.jsx` - 文章视频模板
- `src/components/video/MicroVideo.jsx` - 微头条视频模板
- `src/components/video/VideoPreview.jsx` - 视频预览组件
- `src/components/video/BatchGeneration.jsx` - 批量生成组件

### 6. 用户认证模块

**职责**：
- 用户登录与注册
- JWT 认证
- 权限管理
- 会话管理

**核心文件**：
- `server/routes/auth.js` - 认证 API 路由
- `server/utils/auth.js` - 认证工具

## 部署架构

### 开发环境

```
本地开发机器
    ├── Vite 开发服务器 (端口 8080)
    │   ├── 热更新 (HMR)
    │   └── 代理 API 请求
    └── Express 后端服务器 (端口 5000)
        ├── MongoDB (端口 27017)
        └── Redis (端口 6379)
```

### 生产环境

```
Docker 容器化部署
    ├── Nginx 反向代理 (端口 80/443)
    │   ├── 静态资源服务
    │   └── API 路由转发
    ├── 前端应用容器 (端口 3000)
    ├── 后端 API 容器 (端口 5000)
    │   └── PM2 进程管理
    ├── MongoDB 容器 (端口 27017)
    │   └── 数据持久化卷
    └── Redis 容器 (端口 6379)
        └── 数据持久化卷
```

## 安全机制

### API 安全

- **限流保护**：使用 `rate-limiter-flexible` 防止 API 滥用
- **CORS 配置**：跨域资源共享控制
- **Helmet 中间件**：HTTP 头安全配置
- **请求体大小限制**：防止大文件攻击

### 数据安全

- **JWT 认证**：无状态认证机制
- **密码加密**：使用 bcryptjs 加密用户密码
- **环境变量隔离**：敏感信息存储在环境变量中
- **MongoDB 认证**：数据库用户名密码认证

### 内容安全

- **内容审核**：集成 AI 内容审核
- **敏感词过滤**：自动过滤违规内容
- **发布审核**：支持人工审核流程

## 性能优化

### 前端优化

- **代码分割**：按路由懒加载组件
- **图片优化**：使用 WebP 格式，懒加载
- **缓存策略**：TanStack Query 自动缓存 API 响应
- **虚拟滚动**：长列表使用虚拟滚动

### 后端优化

- **Redis 缓存**：热点数据、用户会话缓存
- **数据库索引**：关键字段建立索引
- **连接池**：数据库连接复用
- **压缩中间件**：Gzip 压缩响应

### 部署优化

- **PM2 集群模式**：多进程利用多核 CPU
- **Nginx 负载均衡**：分发请求到多个后端实例
- **CDN 加速**：静态资源 CDN 分发
- **Docker 资源限制**：防止资源耗尽

## 扩展性设计

### 水平扩展

- **无状态设计**：后端服务无状态，可任意横向扩展
- **数据库读写分离**：支持主从复制
- **Redis 集群**：支持 Redis Cluster
- **负载均衡**：Nginx 支持多后端实例

### 垂直扩展

- **微服务化**：模块可拆分为独立服务
- **事件驱动**：引入消息队列（RabbitMQ/Kafka）
- **异步处理**：耗时任务异步执行
- **任务调度**：分布式任务调度（Bull）

## 监控与运维

### 日志系统

- **Winston 日志**：结构化日志，支持多输出
- **日志级别**：ERROR、WARN、INFO、DEBUG
- **日志轮转**：按日期和大小轮转
- **日志分析**：集成 ELK 栈（可选）

### 健康检查

- **API 健康端点**：`/api/health`
- **数据库连接检查**：MongoDB 连接状态
- **缓存检查**：Redis 连接状态
- **外部服务检查**：AI 服务可用性

### 告警机制

- **进程监控**：PM2 自动重启异常进程
- **资源监控**：CPU、内存、磁盘使用率
- **错误告警**：错误率超过阈值告警
- **服务降级**：关键服务故障时降级处理

## 未来规划

### 短期目标

- [x] 完成模块化架构重构（TrendRadar 借鉴）
- [x] LiteLLM 集成（支持 100+ AI 提供商）
- [x] MCP 服务器实现
- [x] 多渠道通知调度
- [x] 报告生成组件
- [ ] 完成今日头条发布集成
- [ ] 添加微博发布功能
- [ ] 优化 AI 内容生成质量
- [ ] 添加内容审核功能

### 中期目标

- [ ] 支持微信公众号发布
- [ ] 支持抖音发布
- [ ] 支持小红书发布
- [ ] 添加用户画像分析

### 长期目标

- [ ] 构建内容推荐系统
- [ ] 实现 AI 自动选题
- [ ] 支持多账号管理
- [ ] 建立创作者社区
