# 数据分析

## 概述

数据分析模块负责收集、聚合和展示内容在各平台的表现数据，帮助用户了解内容的传播效果，优化创作策略。系统提供多维度的数据分析，包括总览数据、内容统计、平台表现、热门内容等。

## 数据指标

### 核心指标

| 指标 | 说明 | 计算方式 |
|------|------|----------|
| 总浏览量 | 所有内容的累计浏览次数 | Σ views |
| 总点赞数 | 所有内容的累计点赞次数 | Σ likes |
| 总评论数 | 所有内容的累计评论次数 | Σ comments |
| 总分享数 | 所有内容的累计分享次数 | Σ shares |
| 平均浏览量 | 单篇内容的平均浏览次数 | Σ views / content_count |
| 平均点赞率 | 点赞数/浏览量的平均比例 | (Σ likes / Σ views) × 100% |
| 平均评论率 | 评论数/浏览量的平均比例 | (Σ comments / Σ views) × 100% |
| 平均分享率 | 分享数/浏览量的平均比例 | (Σ shares / Σ views) × 100% |

### 增长指标

| 指标 | 说明 | 计算方式 |
|------|------|----------|
| 日增长率 | 相比前一日的增长率 | (今日值 - 昨日值) / 昨日值 × 100% |
| 周增长率 | 相比上周同期的增长率 | (本周值 - 上周值) / 上周值 × 100% |
| 月增长率 | 相比上月同期的增长率 | (本月值 - 上月值) / 上月值 × 100% |

## 数据维度

### 时间维度

#### 1. 日数据

- **粒度**: 天
- **用途**: 日度趋势分析
- **数据点**: 最近 30 天

#### 2. 周数据

- **粒度**: 周
- **用途**: 周度趋势分析
- **数据点**: 最近 12 周

#### 3. 月数据

- **粒度**: 月
- **用途**: 月度趋势分析
- **数据点**: 最近 12 个月

### 平台维度

支持多平台数据对比：
- 今日头条
- 微博
- 微信公众号
- 抖音
- 小红书

### 内容维度

- 内容类型：长文章、微头条、视频脚本、音频脚本
- 内容分类：科技、娱乐、财经、体育、社会、国际
- 内容状态：草稿、审核中、已发布

## 数据聚合

### 聚合策略

系统使用 MongoDB 的聚合框架进行数据聚合：

```javascript
// 按平台聚合
const platformStats = await PublishRecord.aggregate([
  {
    $group: {
      _id: '$platform',
      total: { $sum: 1 },
      success: {
        $sum: { $cond: [{ $eq: ['$status', 'success'] }, 1, 0] }
      },
      totalViews: { $sum: '$metrics.views' },
      totalLikes: { $sum: '$metrics.likes' },
      totalComments: { $sum: '$metrics.comments' },
      totalShares: { $sum: '$metrics.shares' }
    }
  }
]);
```

```javascript
// 按时间聚合
const timeSeries = await PublishRecord.aggregate([
  {
    $match: {
      publishTime: { $gte: startDate, $lte: endDate }
    }
  },
  {
    $group: {
      _id: {
        date: { $dateToString: { format: '%Y-%m-%d', date: '$publishTime' } }
      },
      views: { $sum: '$metrics.views' },
      likes: { $sum: '$metrics.likes' },
      comments: { $sum: '$metrics.comments' },
      shares: { $sum: '$metrics.shares' }
    }
  },
  {
    $sort: { '_id.date': 1 }
  }
]);
```

### 计算指标

```javascript
// 计算平均指标
function calculateAverage(records, metric) {
  const total = records.reduce((sum, r) => sum + r.metrics[metric], 0);
  const count = records.length;
  return count > 0 ? total / count : 0;
}

// 计算增长率
function calculateGrowthRate(current, previous) {
  if (previous === 0) return 0;
  return ((current - previous) / previous) * 100;
}

// 计算互动率
function calculateEngagementRate(views, likes, comments, shares) {
  if (views === 0) return 0;
  const interactions = likes + comments + shares;
  return (interactions / views) * 100;
}
```

## 数据缓存

### 缓存策略

| 缓存键 | TTL | 说明 |
|--------|-----|------|
| `analytics:overview` | 5 分钟 | 总览数据 |
| `analytics:content:{date}` | 1 小时 | 指定日期的内容统计 |
| `analytics:platform` | 1 小时 | 平台表现数据 |
| `analytics:top-content` | 30 分钟 | 热门内容 |

### 缓存更新

- **定时更新**: 每 5 分钟更新总览数据
- **主动更新**: 数据变更时更新相关缓存
- **被动更新**: 请求时缓存失效自动重新计算

## 可视化展示

### 1. 总览卡片

展示关键指标：
- 今日热点数
- 今日生成内容数
- 今日发布内容数
- 总浏览量
- 总点赞数
- 总评论数

**组件**: `Analytics.jsx` 中的统计卡片

### 2. 趋势图表

使用 Recharts 展示趋势数据：

```jsx
<ResponsiveContainer width="100%" height={300}>
  <LineChart data={trendData}>
    <CartesianGrid strokeDasharray="3 3" />
    <XAxis dataKey="date" />
    <YAxis />
    <Tooltip />
    <Legend />
    <Line type="monotone" dataKey="views" stroke="#8884d8" />
    <Line type="monotone" dataKey="likes" stroke="#82ca9d" />
  </LineChart>
</ResponsiveContainer>
```

### 3. 平台对比

使用柱状图对比不同平台的表现：

```jsx
<ResponsiveContainer width="100%" height={300}>
  <BarChart data={platformData}>
    <CartesianGrid strokeDasharray="3 3" />
    <XAxis dataKey="platform" />
    <YAxis />
    <Tooltip />
    <Legend />
    <Bar dataKey="views" fill="#8884d8" />
    <Bar dataKey="likes" fill="#82ca9d" />
  </BarChart>
</ResponsiveContainer>
```

### 4. 分布图表

使用饼图展示内容分布：

```jsx
<ResponsiveContainer width="100%" height={300}>
  <PieChart>
    <Pie data={distributionData} dataKey="value" nameKey="name">
      <Cell fill="#8884d8" />
      <Cell fill="#82ca9d" />
      <Cell fill="#ffc658" />
    </Pie>
    <Tooltip />
    <Legend />
  </PieChart>
</ResponsiveContainer>
```

### 5. 热门内容列表

展示表现最好的内容：

```jsx
<div className="space-y-4">
  {topContent.map((content, index) => (
    <div key={content._id} className="flex items-center space-x-4">
      <div className="text-2xl font-bold text-gray-400">
        {index + 1}
      </div>
      <div className="flex-1">
        <h3 className="font-semibold">{content.title}</h3>
        <p className="text-sm text-gray-500">
          浏览: {content.views} | 点赞: {content.likes}
        </p>
      </div>
    </div>
  ))}
</div>
```

## API 接口

### 获取总览数据

```
GET /api/analytics/overview
```

**响应**:
```json
{
  "success": true,
  "data": {
    "totalHotTopics": 156,
    "totalContents": 89,
    "totalPublished": 45,
    "totalViews": 100000,
    "totalLikes": 5000,
    "todayHotTopics": 12,
    "todayGenerated": 8,
    "todayPublished": 5,
    "platformDistribution": [
      { "platform": "toutiao", "count": 30, "percentage": 67 },
      { "platform": "weibo", "count": 15, "percentage": 33 }
    ],
    "contentTypeDistribution": [
      { "type": "article", "count": 40, "percentage": 45 },
      { "type": "micro", "count": 30, "percentage": 34 },
      { "type": "video", "count": 19, "percentage": 21 }
    ]
  }
}
```

### 获取内容统计

```
GET /api/analytics/content
```

**查询参数**:
- `startDate`: 开始日期 (YYYY-MM-DD)
- `endDate`: 结束日期 (YYYY-MM-DD)
- `groupBy`: 分组方式 (day/week/month)

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "date": "2024-02-14",
      "generated": 10,
      "published": 5,
      "views": 2000,
      "likes": 100,
      "comments": 20,
      "shares": 10
    }
  ]
}
```

### 获取平台表现

```
GET /api/analytics/platforms
```

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "platform": "toutiao",
      "totalPublished": 30,
      "totalViews": 80000,
      "avgViews": 2667,
      "totalLikes": 4000,
      "avgLikes": 133,
      "totalComments": 400,
      "avgComments": 13,
      "totalShares": 150,
      "avgShares": 5,
      "engagementRate": 5.75
    }
  ]
}
```

### 获取热门内容

```
GET /api/analytics/top-content
```

**查询参数**:
- `limit`: 返回数量，默认 10
- `sortBy`: 排序字段 (views/likes/comments/shares)

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "_id": "60d5ec9f8b8c6d1e8c8d7e8b",
      "title": "人工智能在医疗领域的应用",
      "type": "article",
      "platform": "toutiao",
      "views": 5000,
      "likes": 300,
      "comments": 50,
      "shares": 20,
      "publishTime": "2024-02-14T11:00:00Z"
    }
  ]
}
```

## 数据更新机制

### 定时更新

```javascript
// 每小时更新数据指标
cron.schedule('0 * * * *', async () => {
  try {
    console.log('开始更新数据指标...');
    await updateMetricsForAllPublished();
    console.log('数据指标更新完成');
  } catch (error) {
    console.error('数据指标更新失败:', error);
  }
});
```

### 增量更新

只更新有变化的数据，减少计算量：

```javascript
async function incrementallyUpdateMetrics() {
  const records = await PublishRecord.find({
    status: 'success',
    updatedAt: { $gte: lastUpdateTime }
  });

  for (const record of records) {
    const metrics = await fetchMetricsFromPlatform(record);
    await PublishRecord.findByIdAndUpdate(record._id, {
      metrics,
      updatedAt: new Date()
    });
  }
}
```

## 数据导出

### 导出格式

支持以下格式：
- CSV
- Excel
- JSON

### 导出接口

```
GET /api/analytics/export
```

**查询参数**:
- `format`: 导出格式 (csv/excel/json)
- `startDate`: 开始日期
- `endDate`: 结束日期

## 最佳实践

### 1. 定期查看数据

建议每天查看数据，及时发现问题和机会。

### 2. 多维度分析

从时间、平台、内容类型等多个维度分析，获得全面洞察。

### 3. 关注增长趋势

关注增长率而非绝对值，了解内容的发展趋势。

### 4. 对比分析

对比不同平台、不同内容类型的表现，找到最优策略。

### 5. 数据驱动决策

基于数据分析结果，优化选题、发布时间和内容风格。

## 性能优化

### 1. 分页加载

大数据集使用分页，避免一次性加载过多数据。

### 2. 虚拟滚动

长列表使用虚拟滚动，提升渲染性能。

### 3. 数据聚合优化

使用 MongoDB 的聚合管道，减少数据传输量。

### 4. 缓存策略

合理使用缓存，减少数据库查询。

## 扩展规划

### 短期

- [ ] 添加更多数据指标
- [ ] 优化图表展示
- [ ] 支持数据导出

### 中期

- [ ] 实现数据对比功能
- [ ] 添加自定义报表
- [ ] 支持数据预警

### 长期

- [ ] 构建数据预测模型
- [ ] 实现智能推荐
- [ ] 支持多租户分析
