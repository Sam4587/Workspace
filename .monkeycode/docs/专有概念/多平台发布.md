# 多平台发布

## 概述

多平台发布模块负责将生成的内容自动发布到各大平台（今日头条、微博、微信公众号、抖音、小红书等），实现内容的多渠道分发，最大化内容曝光和影响力。系统支持立即发布和定时发布，并提供发布状态跟踪和数据指标更新。

## 支持的平台

### 1. 今日头条 (Toutiao)

**状态**: 开发中

**内容类型**:
- 长文章
- 微头条

**API 能力**:
- 发布文章
- 更新文章
- 删除文章
- 获取文章数据
- 获取评论列表

**限制**:
- 每日发布数量限制
- 内容审核机制
- 封面图要求

### 2. 微博 (Weibo)

**状态**: 规划中

**内容类型**:
- 长文章
- 微博正文

**API 能力**:
- 发布微博
- 上传图片
- 发布视频
- 获取评论
- 获取转发数据

### 3. 微信公众号 (WeChat)

**状态**: 规划中

**内容类型**:
- 图文消息
- 视频消息

**API 能力**:
- 发布图文
- 上传素材
- 获取阅读数据
- 获取用户数据

### 4. 抖音 (Douyin)

**状态**: 规划中

**内容类型**:
- 短视频

**API 能力**:
- 发布视频
- 上传视频
- 获取播放数据
- 获取评论数据

### 5. 小红书 (Xiaohongshu)

**状态**: 规划中

**内容类型**:
- 图文笔记
- 视频笔记

**API 能力**:
- 发布笔记
- 上传图片
- 获取互动数据

## 发布机制

### 立即发布

用户点击"立即发布"后，系统立即调用平台 API 发布内容。

```
用户点击发布
    ↓
创建发布记录（status: pending）
    ↓
调用平台 API
    ├── 请求参数封装
    ├── 签名/认证
    └── 发送请求
    ↓
解析响应
    ├── 成功：更新记录为 success
    ├── 失败：更新记录为 failed
    └── 保存平台 URL
    ↓
更新内容状态（status: published）
    ↓
返回结果给前端
```

### 定时发布

用户可以设置发布时间，系统在指定时间自动发布。

```
用户设置定时发布
    ↓
创建发布记录（status: pending）
    ↓
保存定时时间
    ↓
定时任务检查
    （每分钟执行）
    ↓
到达发布时间？
    ↓
立即发布
```

### 批量发布

用户可以选择多个内容，批量发布到多个平台。

```
用户选择内容和平台
    ↓
创建多个发布记录
    ↓
并行发布
    ├── 平台 A
    ├── 平台 B
    └── 平台 C
    ↓
更新所有记录状态
    ↓
返回批量发布结果
```

## 平台适配

### 内容适配

不同平台对内容格式有不同要求，系统会自动适配：

| 平台 | 标题长度 | 内容长度 | 支持格式 |
|------|----------|----------|----------|
| 今日头条 | 5-30 字 | 500-10000 字 | 文字、图片、视频 |
| 微博 | 无限制 | 140-2000 字 | 文字、图片、视频 |
| 微信公众号 | 5-64 字 | 无限制 | 文字、图片、视频 |
| 抖音 | 5-50 字 | 300-1500 字（字幕） | 视频 |
| 小红书 | 5-20 字 | 300-1000 字 | 图文、视频 |

### 图片处理

**封面图生成**:
```javascript
function generateCoverImage(title) {
  const keywords = title.slice(0, 10);
  return {
    url: `https://api.example.com/generate?keyword=${encodeURIComponent(keywords)}`,
    width: 800,
    height: 400,
    format: 'jpg'
  };
}
```

**图片上传**:
1. 生成本地图片
2. 调用平台上传接口
3. 获取图片 URL
4. 关联到内容

### 标签处理

不同平台的标签格式不同，系统会自动转换：

**今日头条**:
```javascript
const tags = ['人工智能', '医疗', 'AI'];
// 直接使用
```

**微博**:
```javascript
const tags = ['人工智能', '医疗', 'AI'];
// 转换为 #人工智能# #医疗# #AI#
```

**小红书**:
```javascript
const tags = ['人工智能', '医疗', 'AI'];
// 转换为 #人工智能 #医疗 #AI
```

## 发布状态管理

### 状态定义

| 状态 | 说明 | 可转换到 |
|------|------|----------|
| pending | 等待发布 | success, failed |
| success | 发布成功 | - |
| failed | 发布失败 | pending (重试) |

### 状态转换

```
pending → success (发布成功)
  ↓
pending → failed (发布失败)
  ↓
failed → pending (重试)
```

### 状态跟踪

系统会持续跟踪发布状态，更新到前端。

```javascript
// WebSocket 实时推送
io.emit('publish:status', {
  recordId,
  status,
  platformUrl,
  timestamp
});
```

## 数据指标更新

### 指标类型

| 指标 | 说明 | 更新频率 |
|------|------|----------|
| views | 浏览量 | 每小时 |
| likes | 点赞数 | 每小时 |
| comments | 评论数 | 每小时 |
| shares | 分享数 | 每小时 |

### 更新机制

```
定时任务（每小时）
    ↓
遍历已发布内容
    ↓
调用平台数据接口
    ├── 获取浏览量
    ├── 获取点赞数
    ├── 获取评论数
    └── 获取分享数
    ↓
更新到数据库
    ↓
计算增长率
    ↓
缓存到 Redis
```

### 数据聚合

```javascript
async function aggregateMetrics(contentId, timeframe) {
  const metrics = await PublishRecord.find({
    contentId,
    publishTime: { $gte: Date.now() - timeframe }
  });

  return {
    totalViews: metrics.reduce((sum, r) => sum + r.metrics.views, 0),
    totalLikes: metrics.reduce((sum, r) => sum + r.metrics.likes, 0),
    avgViews: calculateAverage(metrics, 'views'),
    growthRate: calculateGrowth(metrics)
  };
}
```

## 数据模型

### PublishRecord Schema

```javascript
{
  _id: ObjectId,
  contentId: ObjectId,          // 关联的内容 ID
  platform: String,             // 平台：toutiao/weibo/weixin/douyin/xiaohongshu
  status: String,               // 状态：pending/success/failed
  publishTime: Date,           // 发布时间
  scheduledTime: Date,         // 定时发布时间
  platformUrl: String,         // 平台内容 URL
  failReason: String,          // 失败原因
  metrics: {
    views: Number,            // 浏览量
    likes: Number,            // 点赞数
    comments: Number,          // 评论数
    shares: Number            // 分享数
  },
  createdAt: Date,
  updatedAt: Date
}
```

## API 接口

### 发布到平台

```
POST /api/publish/:platform
```

**路径参数**:
- `platform`: 平台名称（toutiao/weibo/weixin）

**请求体**:
```json
{
  "contentId": "60d5ec9f8b8c6d1e8c8d7e8b",
  "scheduledTime": "2024-02-15T10:00:00Z"
}
```

### 获取发布队列

```
GET /api/publish/queue
```

**查询参数**:
- `page`: 页码
- `limit`: 每页数量
- `status`: 状态筛选

### 获取发布历史

```
GET /api/publish/history
```

**查询参数**:
- `page`: 页码
- `limit`: 每页数量
- `platform`: 平台筛选

### 获取发布统计

```
GET /api/publish/stats
```

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "_id": "toutiao",
      "total": 50,
      "success": 45,
      "failed": 5,
      "totalViews": 100000,
      "totalLikes": 5000,
      "totalComments": 500,
      "totalShares": 200
    }
  ]
}
```

## 错误处理

### 常见错误

| 错误类型 | 原因 | 处理方式 |
|----------|------|----------|
| AUTH_FAILED | 认证失败 | 提示重新授权 |
| CONTENT_INVALID | 内容违规 | 提示修改内容 |
| RATE_LIMITED | 频率超限 | 延迟重试 |
| NETWORK_ERROR | 网络错误 | 自动重试 |
| API_ERROR | API 错误 | 记录日志，通知用户 |

### 重试策略

```javascript
async function publishWithRetry(content, platform, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await publishToPlatform(content, platform);
    } catch (error) {
      if (error.code === 'AUTH_FAILED') break; // 认证失败不重试
      if (i === maxRetries - 1) throw error;
      await sleep(1000 * Math.pow(2, i)); // 指数退避
    }
  }
}
```

## 最佳实践

### 1. 分时段发布

根据目标受众的活跃时间，选择最佳发布时间。

| 平台 | 最佳发布时间 |
|------|------------|
| 今日头条 | 7:00-9:00, 12:00-14:00, 18:00-22:00 |
| 微博 | 8:00-10:00, 12:00-14:00, 20:00-23:00 |
| 微信公众号 | 21:00-23:00 |
| 抖音 | 18:00-23:00 |

### 2. 多平台适配

根据不同平台的特点，调整内容形式和风格。

### 3. 持续跟踪

定期查看数据指标，优化发布策略。

### 4. 互动管理

及时回复评论，提高内容互动率。

## 安全机制

### 1. 访问令牌管理

- 使用 OAuth 2.0 获取访问令牌
- 令牌自动刷新
- 安全存储令牌

### 2. 内容审核

发布前进行内容审核，避免违规。

### 3. 频率限制

遵守各平台的发布频率限制。

### 4. 数据加密

敏感信息加密存储，保护用户隐私。

## 性能优化

### 1. 批量操作

使用平台批量接口，减少 API 调用次数。

### 2. 异步处理

发布操作异步执行，提升响应速度。

### 3. 结果缓存

缓存发布结果，避免重复查询。

### 4. 队列管理

使用消息队列管理发布任务，保证可靠性。

## 扩展规划

### 短期

- [ ] 完成今日头条发布集成
- [ ] 添加微博发布功能
- [ ] 优化发布流程

### 中期

- [ ] 支持微信公众号发布
- [ ] 支持抖音发布
- [ ] 支持小红书发布

### 长期

- [ ] 支持自定义平台
- [ ] 构建平台分发策略
- [ ] 实现智能推荐发布时间
