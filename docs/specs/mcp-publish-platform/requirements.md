# 抖音和今日头条 MCP 发布工具需求文档

## 需求概述

开发一个基于小红书 MCP (https://github.com/xpzouying/xiaohongshu-mcp) 成熟架构的 MCP 发布工具，支持抖音和今日头条平台的内容发布、内容管理和交互操作。

## 核心目标

1. **复用成熟框架**：完全复用小红书 MCP 的技术架构（Go + Rod + HTTP/MCP 协议）
2. **平台支持**：支持抖音和今日头条的内容发布
3. **功能完整性**：实现登录认证、内容发布、内容管理、MCP 协议层
4. **易于集成**：提供标准 HTTP API 和 MCP 协议端点，可接入 Cherry Studio/AnythingLLM 等客户端
5. **可部署**：交付可执行文件 + 配置文件，开箱即用

## 功能需求

### 1. 登录认证模块

#### 1.1 二维码登录

**需求 ID**: AUTH-001
**需求描述**: 支持通过二维码扫描方式登录抖音和今日头条账号

**验收标准**:
1. WHEN 用户请求登录时，系统 SHALL 使用 Rod 打开平台登录页面
2. WHEN 登录页面加载完成后，系统 SHALL 生成或获取二维码
3. WHEN 二维码生成成功后，系统 SHALL 返回二维码图片数据或 URL 给前端
4. WHEN 用户扫描二维码并完成授权后，系统 SHALL 自动检测登录状态变化
5. WHEN 检测到登录成功后，系统 SHALL 提取关键 Cookie 或 Token 并持久化存储

#### 1.2 Token/Cookie 管理

**需求 ID**: AUTH-002
**需求描述**: 管理平台的认证凭证，包括存储、验证和刷新

**验收标准**:
1. WHEN 登录成功后，系统 SHALL 提取并存储以下凭证：
   - 抖音：`tt_webid`、`passport_auth`、`csrf_token`、`ttcid`
   - 今日头条：`sessionid`、`passport_auth`、`tt_token`
2. WHEN 存储凭证时，系统 SHALL 使用加密方式保存到配置文件或数据库
3. WHEN 系统启动时，系统 SHALL 自动加载已存储的凭证
4. WHEN 使用凭证进行 API 调用前，系统 SHALL 验证凭证的有效性
5. WHEN 凭证失效时，系统 SHALL 返回明确的错误信息并提示重新登录

#### 1.3 登录状态检查

**需求 ID**: AUTH-003
**需求描述**: 提供 API 接口检查当前登录凭证是否有效

**验收标准**:
1. WHEN 前端请求登录状态时，系统 SHALL 使用存储的凭证访问平台首页或 API
2. WHEN 访问成功且响应码为 200 时，系统 SHALL 返回登录有效状态
3. WHEN 访问失败或响应包含跳转登录页时，系统 SHALL 返回登录失效状态
4. WHEN 返回登录状态时，系统 SHALL 同时返回用户信息（如用户名、头像）

### 2. 内容发布模块

#### 2.1 图文内容发布

**需求 ID**: PUBLISH-001
**需求描述**: 支持发布图文形式的内容（文字 + 多张图片）

**验收标准**:
1. WHEN 接收到图文发布请求时，系统 SHALL 验证必需参数（标题、正文、图片列表）
2. WHEN 验证通过后，系统 SHALL 使用 Rod 打开平台发布页面
3. WHEN 打开发布页面后，系统 SHALL 模拟点击发布按钮
4. WHEN 需要上传图片时，系统 SHALL 支持本地图片上传，模拟文件选择对话框
5. WHEN 图片上传完成后，系统 SHALL 填写标题和正文内容到对应输入框
6. WHEN 所有内容填写完成且图片上传成功后，系统 SHALL 点击发布按钮
7. WHEN 发布请求发送后，系统 SHALL 监听页面响应，判断发布成功或失败
8. WHEN 发布成功时，系统 SHALL 返回作品 URL 或作品 ID
9. WHEN 发布失败时，系统 SHALL 返回详细的错误信息

#### 2.2 视频内容发布

**需求 ID**: PUBLISH-002
**需求描述**: 支持发布视频内容到抖音和今日头条

**验收标准**:
1. WHEN 接收到视频发布请求时，系统 SHALL 验证视频文件路径、标题、描述等参数
2. WHEN 验证通过后，系统 SHALL 检查视频文件是否符合平台要求：
   - 抖音：大小不超过 2GB，格式为 MP4
   - 今日头条：格式为 MP4，大小符合平台限制
3. WHEN 视频文件过大时，系统 SHALL 实现视频切片功能，将大文件拆分为多个片段
4. WHEN 视频上传过程中，系统 SHALL 提供进度回调，实时报告上传进度（0-100%）
5. WHEN 视频上传完成后，系统 SHALL 等待平台转码完成
6. WHEN 转码完成后，系统 SHALL 填写标题、描述等元信息
7. WHEN 所有信息填写完成后，系统 SHALL 点击发布按钮
8. WHEN 发布成功时，系统 SHALL 返回作品 URL 和作品 ID
9. WHEN 发布失败时，系统 SHALL 返回错误信息

#### 2.3 标签和话题管理

**需求 ID**: PUBLISH-003
**需求描述**: 支持为发布内容添加标签和话题，提升内容曝光

**验收标准**:
1. WHEN 接收到带有标签的发布请求时，系统 SHALL 解析平台的话题选择器组件
2. WHEN 找到话题输入框时，系统 SHALL 模拟点击话题输入框
3. WHEN 话题列表展开时，系统 SHALL 根据传入的话题 ID 或名称选择对应话题
4. WHEN 平台支持标签输入时，系统 SHALL 模拟输入标签文本并确认
5. WHEN 无法找到指定话题时，系统 SHALL 返回警告信息但仍尝试手动输入

#### 2.4 定时发布

**需求 ID**: PUBLISH-004
**需求描述**: 支持设置内容的定时发布时间

**验收标准**:
1. WHEN 接收到带定时时间的发布请求时，系统 SHALL 在发布页面找到定时发布选项
2. WHEN 找到定时发布选项时，系统 SHALL 点击该选项
3. WHEN 定时发布时间选择器展开时，系统 SHALL 设置指定的发布时间
4. WHEN 定时时间设置完成后，系统 SHALL 提交定时发布请求
5. WHEN 定时发布设置成功时，系统 SHALL 返回定时发布状态和预计发布时间

### 3. 内容管理模块

#### 3.1 内容列表查询

**需求 ID**: CONTENT-001
**需求描述**: 获取用户已发布的内容列表，包括 Feed ID、标题、发布时间、数据指标

**验收标准**:
1. WHEN 接收到内容列表查询请求时，系统 SHALL 使用 Rod 打开平台个人主页或作品管理页
2. WHEN 页面加载完成后，系统 SHALL 解析 DOM 获取作品列表
3. WHILE 存在分页时，系统 SHALL 支持翻页获取更多内容
4. WHEN 解析成功后，系统 SHALL 返回结构化的内容列表，每个项目包含：
   - 作品 ID
   - 作品类型（图文/视频）
   - 标题
   - 封面图 URL
   - 发布时间
   - 播放量/阅读量
   - 点赞数
   - 评论数
   - 分享数
5. WHEN 列表数据为空时，系统 SHALL 返回空列表状态

#### 3.2 内容详情查询

**需求 ID**: CONTENT-002
**需求描述**: 根据作品 ID 获取内容的详细信息，包括完整数据指标

**验收标准**:
1. WHEN 接收到作品 ID 查询请求时，系统 SHALL 打开作品详情页
2. WHEN 详情页加载完成后，系统 SHALL 解析页面获取详细数据
3. WHEN 解析成功后，系统 SHALL 返回作品的详细信息，包括：
   - 基本信息（标题、描述、封面、标签）
   - 发布信息（发布时间、定时发布状态）
   - 互动数据（播放量、点赞数、评论数、分享数、收藏数）
   - 审核状态（已发布、审核中、审核失败）
4. WHEN 作品不存在或已被删除时，系统 SHALL 返回作品不存在错误

#### 3.3 互动操作

**需求 ID**: CONTENT-003
**需求描述**: 支持对已发布内容进行点赞、评论、收藏等互动操作

**验收标准**:
1. WHEN 接收到点赞请求时，系统 SHALL 打开作品详情页
2. WHEN 详情页加载完成后，系统 SHALL 定位到点赞按钮元素
3. WHEN 找到点赞按钮时，系统 SHALL 模拟点击操作
4. WHEN 点赞成功后，系统 SHALL 返回操作成功状态
5. WHEN 收到评论请求时，系统 SHALL 在详情页找到评论输入框
6. WHEN 找到评论输入框时，系统 SHALL 输入评论内容并模拟点击发送
7. WHEN 评论成功后，系统 SHALL 返回评论 ID 和操作成功状态
8. WHEN 收到收藏请求时，系统 SHALL 找到收藏按钮并模拟点击
9. WHEN 操作失败时，系统 SHALL 返回详细的错误信息

### 4. MCP 协议层

#### 4.1 MCP 服务器实现

**需求 ID**: MCP-001
**需求描述**: 实现标准的 MCP 服务器协议，供 MCP 客户端（如 Cherry Studio、AnythingLLM）连接和调用

**验收标准**:
1. WHEN MCP 客户端发起连接时，系统 SHALL 响应服务器信息（名称、版本、协议版本）
2. WHEN MCP 客户端请求工具列表时，系统 SHALL 返回所有可用的工具及其描述
3. WHEN MCP 客户端调用工具时，系统 SHALL 根据工具名称分发给对应的处理函数
4. WHEN 工具调用过程中发生错误时，系统 SHALL 返回标准 MCP 错误响应
5. WHEN 支持流式输出时，系统 SHALL 按照 MCP 流式协议返回数据
6. WHEN 连接关闭时，系统 SHALL 清理资源，释放 Rod 浏览器实例

#### 4.2 工具定义

**需求 ID**: MCP-002
**需求描述**: 定义抖音和今日头条的所有 MCP 工具，包括名称、描述、参数和返回值

**验收标准**:
1. 当定义抖音登录工具时，系统 SHALL 提供：
   - 工具名称：`douyin_login`
   - 描述：抖音账号登录
   - 参数：无
   - 返回值：登录状态和二维码
2. 当定义抖音图文发布工具时，系统 SHALL 提供：
   - 工具名称：`douyin_publish_image_text`
   - 描述：发布图文内容到抖音
   - 参数：title, content, images[], tags[]
   - 返回值：作品 URL 和发布状态
3. 当定义抖音视频发布工具时，系统 SHALL 提供：
   - 工具名称：`douyin_publish_video`
   - 描述：发布视频到抖音
   - 参数：video_path, title, description, tags[]
   - 返回值：作品 URL 和发布状态
4. 当定义今日头条发布工具时，系统 SHALL 提供：
   - 工具名称：`toutiao_publish`
   - 描述：发布内容到今日头条
   - 参数：type, title, content, images[], video_path, tags[]
   - 返回值：作品 URL 和发布状态
5. 当所有工具定义完成后，系统 SHALL 提供 JSON Schema 格式的工具描述
6. WHEN MCP 客户端请求工具列表时，系统 SHALL 返回完整的工具定义列表

#### 4.3 平台管理

**需求 ID**: MCP-003
**需求描述**: 支持 MCP 协议的平台选择和切换，实现抖音和今日头条的统一管理

**验收标准**:
1. WHEN MCP 客户端连接时，系统 SHALL 返回支持的平台列表（抖音、今日头条）
2. WHEN MCP 客户端选择平台时，系统 SHALL 切换到对应的平台实现
3. WHEN 平台切换成功后，系统 SHALL 重新初始化该平台的登录凭证和浏览器实例
4. WHEN 跨平台操作时，系统 SHALL 独立管理不同平台的凭证和会话
5. WHEN 平台不可用时（如维护中），系统 SHALL 在工具列表中标注该平台状态

### 5. HTTP API 层

#### 5.1 API 设计

**需求 ID**: API-001
**需求描述**: 提供 RESTful HTTP API 接口，方便其他服务调用

**验收标准**:
1. WHEN 设计 API 路径时，系统 SHALL 使用 `/api/{platform}/{action}` 格式
2. WHEN 定义登录接口时，系统 SHALL 提供 `POST /api/{platform}/login`
3. WHEN 定义发布接口时，系统 SHALL 提供 `POST /api/{platform}/publish`
4. WHEN 定义内容列表接口时，系统 SHALL 提供 `GET /api/{platform}/contents`
5. WHEN 定义内容详情接口时，系统 SHALL 提供 `GET /api/{platform}/contents/{id}`
6. WHEN 所有接口定义完成后，系统 SHALL 提供完整的 API 文档
7. WHEN API 请求成功时，系统 SHALL 返回标准的 JSON 响应格式
8. WHEN API 请求失败时，系统 SHALL 返回包含错误码和错误消息的响应

#### 5.2 响应格式

**需求 ID**: API-002
**需求描述**: 定义统一的 API 响应格式

**验收标准**:
1. WHEN 请求成功时，响应 SHALL 包含：
   ```json
   {
     "success": true,
     "data": {},
     "message": "操作成功"
   }
   ```
2. WHEN 请求失败时，响应 SHALL 包含：
   ```json
   {
     "success": false,
     "error": {
       "code": "ERROR_CODE",
       "message": "错误描述"
     }
   }
   ```
3. WHEN 返回分页数据时，响应 SHALL 包含分页信息：
   ```json
   {
     "success": true,
     "data": [],
     "pagination": {
       "page": 1,
       "limit": 20,
       "total": 100,
       "pages": 5
     }
   }
   ```

### 6. 技术架构要求

#### 6.1 技术栈复用

**需求 ID**: ARCH-001
**需求描述**: 完全复用小红书 MCP 的技术架构

**验收标准**:
1. WHEN 选择技术栈时，系统 SHALL 使用 Go 语言
2. WHEN 选择浏览器自动化时，系统 SHALL 使用 Rod 库
3. WHEN 实现 HTTP 服务时，系统 SHALL 复用小红书 MCP 的 HTTP 服务器代码
4. WHEN 实现 MCP 协议时，系统 SHALL 复用小红书 MCP 的 MCP 协议逻辑
5. WHEN 选择日志库时，系统 SHALL 使用相同的日志记录方式
6. WHEN 选择配置管理时，系统 SHALL 使用相同的配置文件格式

#### 6.2 模块化设计

**需求 ID**: ARCH-002
**需求描述**: 采用模块化设计，便于扩展更多平台

**验收标准**:
1. WHEN 设计模块结构时，系统 SHALL 创建平台抽象接口
2. WHEN 实现具体平台时，系统 SHALL 实现平台抽象接口
3. WHEN 添加新平台时，系统 SHALL 只需实现平台接口，无需修改核心逻辑
4. WHEN 定义共享模块时，系统 SHALL 将浏览器自动化、凭证管理、HTTP 服务器等提取为共享模块
5. WHEN 所有模块设计完成后，系统 SHALL 支持通过配置文件启用/禁用特定平台

#### 6.3 反爬虫和风控应对

**需求 ID**: ARCH-003
**需求描述**: 实现反爬虫和风控应对机制，避免被封禁

**验收标准**:
1. WHEN 操作浏览器时，系统 SHALL 禁用 Rod 的无头模式指纹
2. WHEN 设置浏览器时，系统 SHALL 配置随机 User-Agent 和分辨率
3. WHEN 执行操作时，系统 SHALL 添加随机延迟，模拟人工操作
4. WHEN 频繁操作时，系统 SHALL 实现操作间隔限制（发布间隔≥5 分钟）
5. WHEN 检测到风控提示时，系统 SHALL 暂停操作并记录日志
6. WHEN 登录凭证失效时，系统 SHALL 自动触发重新登录流程
7. WHEN 请求被限流时，系统 SHALL 实现指数退避重试机制

### 7. 配置和部署要求

#### 7.1 配置文件

**需求 ID**: CONFIG-001
**需求描述**: 提供配置文件，支持平台配置、日志级别、服务端口等

**验收标准**:
1. WHEN 创建配置文件时，系统 SHALL 支持 JSON 或 YAML 格式
2. WHEN 定义配置项时，系统 SHALL 包含：
   - 服务端口
   - 日志级别
   - 平台凭证存储路径
   - 平台启用/禁用状态
   - 浏览器配置（无头模式、用户代理）
   - 反爬虫配置（延迟范围、操作间隔）
3. WHEN 配置文件修改后，系统 SHALL 支持热重载
4. WHEN 配置文件不存在时，系统 SHALL 使用默认配置并生成配置文件

#### 7.2 部署交付物

**需求 ID**: DEPLOY-001
**需求描述**: 交付可执行文件、配置文件和部署文档

**验收标准**:
1. WHEN 构建可执行文件时，系统 SHALL 支持 Linux、macOS、Windows 三个平台
2. WHEN 打包交付物时，系统 SHALL 包含：
   - 可执行文件
   - 配置文件模板
   - 部署文档
   - API 文档
   - MCP 协议文档
3. WHEN 用户运行可执行文件时，系统 SHALL 自动检查依赖并提示安装
4. WHEN 服务启动时，系统 SHALL 自动加载配置文件
5. WHEN 服务启动成功后，系统 SHALL 输出访问地址和端点信息

### 8. 测试和验证要求

#### 8.1 功能测试

**需求 ID**: TEST-001
**需求描述**: 对所有核心功能进行端到端测试

**验收标准**:
1. WHEN 测试登录功能时，系统 SHALL 验证二维码生成和登录检测
2. WHEN 测试图文发布时，系统 SHALL 验证图片上传、内容填写、发布提交
3. WHEN 测试视频发布时，系统 SHALL 验证视频上传、转码等待、发布提交
4. WHEN 测试内容列表时，系统 SHALL 验证列表解析和分页功能
5. WHEN 测试内容详情时，系统 SHALL 验证详情解析和数据准确性
6. WHEN 测试互动操作时，系统 SHALL 验证点赞、评论、收藏功能
7. WHEN 所有功能测试完成后，系统 SHALL 记录测试结果

#### 8.2 平台兼容性测试

**需求 ID**: TEST-002
**需求描述**: 测试抖音和今日头条平台的功能兼容性

**验收标准**:
1. WHEN 测试抖音平台时，系统 SHALL 验证创作者服务平台的兼容性
2. WHEN 测试今日头条平台时，系统 SHALL 验证头条号后台的兼容性
3. WHEN 发现平台 UI 变化时，系统 SHALL 记录日志并提供适配建议
4. WHEN 测试不同账号时，系统 SHALL 验证不同账号类型的兼容性（个人号、企业号）

#### 8.3 集成测试

**需求 ID**: TEST-003
**需求描述**: 测试与 MCP 客户端和 HTTP API 的集成

**验收标准**:
1. WHEN 测试 MCP 客户端时，系统 SHALL 使用 Cherry Studio 连接并调用工具
2. WHEN 测试 MCP 客户端时，系统 SHALL 使用 AnythingLLM 连接并调用工具
3. WHEN 测试 HTTP API 时，系统 SHALL 使用 curl 或 Postman 调用接口
4. WHEN 所有集成测试完成后，系统 SHALL 验证数据格式和响应一致性
5. WHEN 测试失败时，系统 SHALL 提供详细的错误日志和调试信息

### 9. 文档要求

#### 9.1 API 文档

**需求 ID**: DOC-001
**需求描述**: 编写完整的 API 使用文档

**验收标准**:
1. WHEN 编写 API 文档时，系统 SHALL 包含所有接口的详细说明
2. WHEN 描述接口时，文档 SHALL 包含：请求方法、URL、参数、响应示例
3. WHEN 提供示例时，文档 SHALL 包含 curl 和代码示例
4. WHEN 文档编写完成后，系统 SHALL 使用 Markdown 格式输出

#### 9.2 MCP 协议文档

**需求 ID**: DOC-002
**需求描述**: 编写 MCP 协议集成文档

**验收标准**:
1. WHEN 编写 MCP 文档时，系统 SHALL 说明如何连接到 MCP 服务器
2. WHEN 说明工具调用时，文档 SHALL 提供每个工具的使用示例
3. WHEN 说明平台切换时，文档 SHALL 提供平台选择的接口和方式
4. WHEN 文档完成后，系统 SHALL 适配 Cherry Studio 和 AnythingLLM 的集成方式

#### 9.3 部署文档

**需求 ID**: DOC-003
**需求描述**: 编写部署和运维文档

**验收标准**:
1. WHEN 编写部署文档时，系统 SHALL 说明环境要求和依赖安装
2. WHEN 说明运行方式时，文档 SHALL 提供不同平台的运行命令
3. WHEN 说明配置时，文档 SHALL 提供配置项的详细说明和示例
4. WHEN 说明故障排查时，文档 SHALL 包含常见问题和解决方案

## 技术约束

1. **技术栈**: Go 1.21+，Rod 最新稳定版
2. **平台支持**: Linux、macOS、Windows
3. **性能要求**: 支持并发多个浏览器实例
4. **安全要求**: 凭证加密存储，日志脱敏处理
5. **兼容性**: 复用小红书 MCP 的 MCP 协议实现，确保客户端兼容

## 交付标准

1. **可执行文件**: 提供 Linux、macOS、Windows 三个平台的可执行文件
2. **配置文件**: 提供配置文件模板，包含所有可配置项
3. **文档**: API 文档、MCP 协议文档、部署文档
4. **源代码**: 完整的 Go 源代码，模块化设计
5. **测试报告**: 功能测试、平台兼容性测试、集成测试报告
